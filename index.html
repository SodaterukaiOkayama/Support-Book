<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>サポートブック作成ツール（修正版）</title>

<style>
  :root{
    --a4-w: 210mm;
    --a4-h: 297mm;
    --stroke: rgba(15,23,42,0.14);
    --text: #0b1220;
    --muted: rgba(15,23,42,0.64);
    --accent: #2563eb;
    --accent2:#7c3aed;
    --sheet-scale: 0.42; /* スマホ画面での縮小表示率 */
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Segoe UI", sans-serif;
    color:var(--text);
    background:linear-gradient(180deg,#eef2ff, #f8fafc 40%, #f1f5f9);
  }

  /* UI要素（印刷時は消す） */
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--stroke);
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .hdr-left .title{ font-weight:900; font-size:13px; line-height:1.1; }
  .hdr-left .sub{ font-size:11px; color:var(--muted); margin-top:2px; }
  .hdr-right{ display:flex; gap:8px; }

  .btn{
    border:1px solid var(--stroke);
    background:#fff;
    padding:8px 12px;
    border-radius:10px;
    font-size:12px;
    font-weight:700;
    cursor:pointer;
    display:inline-flex; align-items:center; gap:6px;
    white-space:nowrap;
  }
  .btn.primary{
    background:linear-gradient(135deg,var(--accent), var(--accent2));
    color:#fff; border-color:transparent;
  }
  .btn:active{ transform: translateY(1px); }

  main{
    padding:12px;
    display:flex; flex-direction:column; align-items:center; gap:10px;
    padding-bottom: 80px;
  }

  .tabs{ display:flex; gap:6px; overflow:auto; padding:6px 2px; max-width:100%; }
  .tab{
    flex:0 0 auto;
    border:1px solid var(--stroke); background:#fff;
    padding:8px 12px; border-radius:999px;
    font-size:12px; cursor:pointer;
  }
  .tab.active{
    border-color:transparent;
    background: rgba(37,99,235,0.12); color:#1d4ed8; font-weight:900;
  }

  /* 編集画面のプレビュー表示 */
  .stage{ width: min(96vw, 520px); display:flex; justify-content:center; }
  .sheet-wrap{
    transform: scale(var(--sheet-scale));
    transform-origin: top center;
    width: var(--a4-w);
    /* 高さはJSで制御するか、コンテンツなり */
  }

  /* A4用紙のスタイル */
  .sheet{
    width: var(--a4-w);
    height: var(--a4-h);
    background:#fff;
    border:1px solid rgba(2,6,23,0.12);
    border-radius: 4px; /* 印刷プレビュー用に少し丸く */
    box-shadow: 0 16px 46px rgba(2,6,23,0.14);
    position:relative;
    overflow:hidden;
    margin-bottom: 20px;
  }
  
  /* 用紙の背景装飾（画面上のみ表示） */
  .sheet.on-screen:before{
    content:""; position:absolute; inset:-30mm;
    background:
      radial-gradient(22mm 22mm at 20% 20%, rgba(37,99,235,0.10), transparent 60%),
      radial-gradient(26mm 26mm at 85% 15%, rgba(124,58,237,0.10), transparent 60%);
    pointer-events:none;
  }

  .sheet-inner{
    position:absolute; inset:0;
    padding:12mm 10mm; /* 余白調整 */
    display:flex; flex-direction:column; gap:4mm;
  }

  /* コンテンツ部品 */
  .hero{ display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:2mm; }
  .h1{ font-size:24px; font-weight:1000; letter-spacing:0.02em; color:var(--text); }
  
  .meta{ display:flex; gap:6mm; margin-bottom:2mm; }
  
  /* 写真カード */
  .photoCard{
    border:1px solid rgba(2,6,23,0.18);
    border-radius: 8px;
    overflow:hidden; position:relative;
    background: #f8fafc;
    cursor: pointer;
  }
  .photoCard.large{ width: 55mm; height: 70mm; flex:0 0 auto; }
  .photoCard.small{ width: 40mm; height: 30mm; }
  
  .photoCard .ph-placeholder{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    color:#9aa3af; font-size:10px; font-weight:900; text-align:center;
    white-space:pre-line;
    pointer-events:none;
  }
  .photoCard img{
    position:absolute; pointer-events:none;
    transform-origin: center;
  }
  .photoCard .cap{
    position:absolute; left:0; right:0; bottom:0;
    padding:4px 6px;
    font-size:10px; font-weight:900;
    background: rgba(255,255,255,0.9);
    pointer-events:none;
  }
  .photoCard .cap small { display: none; } /* 印刷時は「編集」文字を消す */
  .screen-only .photoCard .cap small { display: inline; color:#666; font-size:9px; margin-left:4px; }

  /* 入力ボックス */
  .infoGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:3mm; flex:1; }
  .box{
    border:1px solid rgba(2,6,23,0.14);
    border-radius: 8px;
    padding:6px 8px;
    background: rgba(255,255,255,0.6);
    min-height: 16mm;
    cursor:pointer;
  }
  .box.wide{ grid-column: 1 / -1; }
  .lbl{ font-size:10px; color:rgba(15,23,42,0.6); font-weight:900; margin-bottom:3px; }
  .val{ font-size:11pt; line-height:1.4; white-space:pre-wrap; word-break:break-word; color:#0b1220; }
  /* 未入力時のヒント（印刷時は消す） */
  .val .hint-text { color: rgba(0,0,0,0.25); font-size:10px; }

  .secTitle{
    margin:2mm 0 1mm 0;
    font-size:13px; font-weight:1000;
    border-bottom:2px solid rgba(15,23,42,0.1);
    padding-bottom:2px;
  }

  .twoCol{ display:grid; grid-template-columns: 1fr 1fr; gap:3mm; }
  .imgGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:3mm; }
  .imgRow{ display:flex; gap:3mm; align-items:center; }

  /* 注釈（画面でのみ表示） */
  .note { font-size:10px; color:var(--muted); margin-top:2px; }

  /* テーブル */
  .table{
    border:1px solid rgba(2,6,23,0.14); border-radius:8px; overflow:hidden;
    font-size:10.5pt;
  }
  .trow{ display:grid; grid-template-columns: 20% 40% 40%; border-top:1px solid rgba(2,6,23,0.1); }
  .trow:first-child{ border-top:none; background:rgba(37,99,235,0.05); font-weight:900; font-size:9pt; }
  .tcell{ padding:6px 8px; white-space:pre-wrap; word-break:break-word; }
  .tcell.btncell{ cursor:pointer; min-height:14mm; }
  .tcell .hint-text{ color:rgba(0,0,0,0.25); font-size:9px; }

  /* モーダル */
  .modal{
    position:fixed; inset:0; z-index:100;
    background:rgba(0,0,0,0.5);
    display:none; align-items:flex-end; justify-content:center;
  }
  .modal.show{ display:flex; }
  .sheetModal{
    width:min(100vw, 700px); background:#fff;
    border-radius:16px 16px 0 0;
    padding:16px; padding-bottom:calc(20px + env(safe-area-inset-bottom));
    display:flex; flex-direction:column; gap:12px;
    max-height: 90vh;
  }
  .mhead{ display:flex; justify-content:space-between; align-items:center; }
  .mbody{ overflow-y:auto; flex:1; }
  textarea{ width:100%; min-height:120px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
  
  /* 印刷・PDF生成用コントロール（重要） */
  @media print {
    /* 印刷時はUIを消す */
    header, .tabs, .hintbar, .modal, .progressWrap, .stage, .no-print { display:none !important; }
    /* 印刷用ホストを表示 */
    #printHost { display:block !important; position:static !important; visibility:visible !important; }
    
    html, body { background: white !important; height:auto !important; }
    main { padding:0 !important; display:block !important; }

    /* 印刷用設定 */
    @page { size: A4 portrait; margin: 0; }
    .sheet {
      page-break-after: always; break-after: page;
      border: none !important; box-shadow: none !important;
      margin: 0 !important; width: 210mm !important; height: 297mm !important;
      transform: none !important;
    }
    .sheet:last-child { page-break-after: auto; }
    
    /* 印刷時にヒントや注釈を消す */
    .hint-text { display: none !important; }
    .note { display: none !important; }
    .ph-placeholder { opacity: 0.1 !important; color:transparent !important; } /* 枠だけ残すか薄くする */
  }

  /* PDF生成用の隠しエリア */
  #printHost {
    display: none; /* 通常時は非表示 */
  }

  /* 進捗バー */
  .progressWrap{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    width:80%; max-width:300px;
    background:#fff; padding:20px; border-radius:12px;
    box-shadow:0 20px 50px rgba(0,0,0,0.3);
    z-index:200; display:none; text-align:center;
  }
  .progressWrap.show{ display:block; }
  .p-bar{ height:6px; background:#eee; border-radius:3px; margin:10px 0; overflow:hidden; }
  .p-fill{ height:100%; background:var(--accent); width:0%; transition:width 0.2s; }

  /* ヒントバー */
  .hintbar{
    background:#fff; border:1px solid var(--stroke); padding:10px; border-radius:8px;
    font-size:11px; color:var(--muted); width:min(96vw, 520px);
  }
</style>
</head>
<body>

<header class="no-print">
  <div class="hdr-left">
    <div class="title">サポートブック作成</div>
    <div class="sub">入力して「保存」ボタンでPDF化</div>
  </div>
  <div class="hdr-right">
    <button class="btn primary" id="btnExportPdf">PDF保存 / 印刷</button>
    <button class="btn" id="btnReset">リセット</button>
  </div>
</header>

<main>
  <div class="hintbar no-print">
    <div>1. 上のタブでページを切り替えます。</div>
    <div>2. 枠をタップして文字や写真を入力します。</div>
    <div>3. 完成したら右上の「PDF保存」を押してください。</div>
    <div style="color:#e11d48; margin-top:4px;">※ 入力欄の薄い文字（ヒント）は印刷されません。</div>
  </div>

  <div class="tabs no-print" id="tabs"></div>
  
  <div class="stage no-print" id="stage"></div>

  <div id="printHost"></div>
</main>

<div class="progressWrap no-print" id="progress">
  <div style="font-weight:bold; margin-bottom:5px;">PDFを作成中...</div>
  <div class="p-bar"><div class="p-fill" id="pFill"></div></div>
  <div style="font-size:10px; color:#666;">※画像が多いと時間がかかります</div>
</div>

<div class="modal" id="modal">
  <div class="sheetModal">
    <div class="mhead">
      <div style="font-weight:bold;">編集</div>
      <button class="btn" id="btnCloseModal">閉じる</button>
    </div>
    <div class="mbody" id="modalBody">
      </div>
    <div class="mhead" style="justify-content:flex-end; gap:10px;">
      <button class="btn" id="btnExample">例文を入力</button>
      <button class="btn primary" id="btnSaveField">決定</button>
    </div>
  </div>
</div>

<input type="file" id="photoFile" accept="image/*" style="display:none" />

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* --- 1. Data & State --- */
const STORAGE_KEY = "sb_v2_data";
const TEMPLATE = {
  pages: [
    { id:"p1", title:"表紙", fields: {
      updatedDate:"", childName:"", nickname:"", birth:"", age:"", diagnosis:"", messageShort:"",
      photoMain:{ dataUrl:"", caption:"本人の写真" },
      photoSub1:{ dataUrl:"", caption:"好きなもの" },
      photoSub2:{ dataUrl:"", caption:"安心グッズ" }
    }},
    { id:"p2", title:"強み・好き", fields: {
      strengths:"", interests:"", triggers:"", calming:"",
      photo1:{ dataUrl:"", caption:"得意" }, photo2:{ dataUrl:"", caption:"好き" }, photo3:{ dataUrl:"", caption:"ハマっている" }
    }},
    { id:"p3", title:"伝え方", fields: {
      understand:"", express:"", supportTips:"",
      photo1:{ dataUrl:"", caption:"視覚支援" }, photo2:{ dataUrl:"", caption:"見本" }, photo3:{ dataUrl:"", caption:"ルール" }
    }},
    { id:"p4", title:"学校生活", fields: {
      sensory:"", life:"", learning:"", schoolArrival:"", schoolClass:"", schoolRecess:"", schoolDismissal:"",
      panicSigns:"", panicSupport:"",
      photo1:{ dataUrl:"", caption:"配慮" }, photo2:{ dataUrl:"", caption:"クールダウン" }, photo3:{ dataUrl:"", caption:"その他" }
    }},
    { id:"p5", title:"場面別・先生へ", fields: {
      rows:[ {s:"予定変更", f:"", t:""}, {s:"一斉指示", f:"", t:""}, {s:"音の過敏", f:"", t:""}, {s:"切り替え", f:"", t:""} ],
      teacherMessage:"",
      photo1:{ dataUrl:"", caption:"連絡帳" }, photo2:{ dataUrl:"", caption:"持ち物" }, photo3:{ dataUrl:"", caption:"配布物" }
    }}
  ]
};

// 例文データ
const EXAMPLES = {
  p1: { messageShort:"環境の変化に敏感ですが、慣れると元気に活動できます。よろしくお願いします。" },
  p2: { strengths:"ルールを守る、集中力がある、記憶力が良い", interests:"電車、ロゴマーク、数字、図鑑", triggers:"大きな音、急な予定変更、待たされること", calming:"イヤーマフをする、静かな場所で休む、タイマーで時間を見る" },
  p3: { understand:"短い言葉で伝える。絵や写真を見せると分かりやすい。", express:"言葉での説明が苦手。二択（AかBか）で聞くと答えやすい。", supportTips:"一度に言わず、一つずつ指示を出す。できた時に具体的に褒める。" },
  p4: { sensory:"チャイムの音が苦手。偏食があり給食は減らしてほしい。", life:"着替えに時間がかかる。トイレは一人で行ける。", learning:"書くことが苦手。板書はタブレット撮影を許可してほしい。", schoolArrival:"朝は機嫌が悪いことがある。", schoolClass:"自信がないと固まる。個別に声をかけてほしい。", schoolRecess:"一人で図書室にいるのが好き。", panicSigns:"独り言が増える、耳をふさぐ", panicSupport:"刺激の少ない場所へ誘導し、落ち着くまでそっとしておく。" },
  p5: { teacherMessage:"何かあった際は連絡帳でお知らせください。家庭でも連携してサポートしていきたいです。" }
};

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || JSON.parse(JSON.stringify(TEMPLATE));
let currentPage = 0;

/* --- 2. Render Logic --- */
const stage = document.getElementById("stage");
const printHost = document.getElementById("printHost");
const tabs = document.getElementById("tabs");

function render(){
  // Tabs
  tabs.innerHTML = "";
  state.pages.forEach((p,i)=>{
    const b = document.createElement("div");
    b.className = "tab" + (i===currentPage ? " active":"");
    b.textContent = p.title;
    b.onclick = ()=>{ currentPage=i; render(); };
    tabs.appendChild(b);
  });

  // Stage (Screen View)
  stage.innerHTML = "";
  // 画面表示用にクラスをつける
  const sheet = renderPage(state.pages[currentPage]);
  sheet.classList.add("on-screen");
  const wrap = document.createElement("div");
  wrap.className = "sheet-wrap";
  wrap.appendChild(sheet);
  stage.appendChild(wrap);

  saveState();
}

// ページ1枚をDOMとして生成する関数
function renderPage(pageData){
  const s = document.createElement("div");
  s.className = "sheet";
  const inner = document.createElement("div");
  inner.className = "sheet-inner";
  s.appendChild(inner);

  const f = pageData.fields;

  // Header Area (全ページ共通か、P1のみ特別か)
  if(pageData.id === "p1"){
    // Hero
    const hero = document.createElement("div");
    hero.className = "hero";
    hero.innerHTML = `<div><div class="h1">サポートブック</div><div class="note">学校・支援者の方へ「この子の取扱説明書」</div></div>`;
    inner.appendChild(hero);

    // Meta & Main Photo
    const meta = document.createElement("div");
    meta.className = "meta";
    
    const ph = renderPhoto(f.photoMain, "large", ()=>editPhoto(pageData.id, "photoMain"));
    meta.appendChild(ph);

    const grid = document.createElement("div");
    grid.className = "infoGrid";
    grid.appendChild(renderBox("更新日", f.updatedDate, "例: 2024/4/1", ()=>editTxt(pageData.id, "updatedDate")));
    grid.appendChild(renderBox("氏名", f.childName, "タップして入力", ()=>editTxt(pageData.id, "childName")));
    grid.appendChild(renderBox("愛称", f.nickname, "例: 〇〇くん", ()=>editTxt(pageData.id, "nickname")));
    grid.appendChild(renderBox("生年月日 / 年齢", f.birth ? `${f.birth} (${f.age}歳)` : "", "タップして入力", ()=>editBirth(pageData.id)));
    grid.appendChild(renderBox("診断名（任意）", f.diagnosis, "入力なしでもOK", ()=>editTxt(pageData.id, "diagnosis"), true));
    grid.appendChild(renderBox("はじめに", f.messageShort, "タップして入力（例文あり）", ()=>editTxt(pageData.id, "messageShort"), true));
    meta.appendChild(grid);
    inner.appendChild(meta);

    // Sub Photos
    inner.appendChild(secTitle("写真（好きなもの・安心グッズ）"));
    const r = document.createElement("div"); r.className = "imgRow";
    r.appendChild(renderPhoto(f.photoSub1, "small", ()=>editPhoto(pageData.id, "photoSub1")));
    r.appendChild(renderPhoto(f.photoSub2, "small", ()=>editPhoto(pageData.id, "photoSub2")));
    r.innerHTML += `<div class="note">※写真枠をタップして画像を設定</div>`;
    inner.appendChild(r);
  } 
  else {
    // Other Pages
    const h = document.createElement("div");
    h.className = "h1";
    h.style.fontSize = "18px"; h.style.marginBottom="4mm";
    h.textContent = pageData.title;
    inner.appendChild(h);

    if(pageData.id === "p2"){
       const ig = document.createElement("div"); ig.className="imgGrid";
       ig.appendChild(renderPhoto(f.photo1,"small",()=>editPhoto("p2","photo1")));
       ig.appendChild(renderPhoto(f.photo2,"small",()=>editPhoto("p2","photo2")));
       ig.appendChild(renderPhoto(f.photo3,"small",()=>editPhoto("p2","photo3")));
       inner.appendChild(ig);
       
       inner.appendChild(secTitle("強み・興味"));
       const g1 = document.createElement("div"); g1.className="infoGrid";
       g1.appendChild(renderBox("強み・得意なこと", f.strengths, "例文あり", ()=>editTxt("p2","strengths"), true));
       g1.appendChild(renderBox("興味・好きなもの", f.interests, "例文あり", ()=>editTxt("p2","interests"), true));
       inner.appendChild(g1);

       inner.appendChild(secTitle("苦手・落ち着く方法"));
       const g2 = document.createElement("div"); g2.className="twoCol";
       g2.appendChild(renderBox("苦手（パニックの要因）", f.triggers, "例文あり", ()=>editTxt("p2","triggers")));
       g2.appendChild(renderBox("落ち着く方法（対応策）", f.calming, "例文あり", ()=>editTxt("p2","calming")));
       inner.appendChild(g2);
    }
    if(pageData.id === "p3"){
       const ig = document.createElement("div"); ig.className="imgGrid";
       ig.appendChild(renderPhoto(f.photo1,"small",()=>editPhoto("p3","photo1")));
       ig.appendChild(renderPhoto(f.photo2,"small",()=>editPhoto("p3","photo2")));
       ig.appendChild(renderPhoto(f.photo3,"small",()=>editPhoto("p3","photo3")));
       inner.appendChild(ig);

       inner.appendChild(secTitle("コミュニケーション"));
       inner.appendChild(renderBox("本人にとって分かりやすい伝え方", f.understand, "例：短い言葉で、絵カードで", ()=>editTxt("p3","understand"), true));
       inner.appendChild(renderBox("本人の意思表示の方法", f.express, "例：クレーン現象、エコラリア", ()=>editTxt("p3","express"), true));
       inner.appendChild(renderBox("支援のコツ", f.supportTips, "例：見通しを伝える", ()=>editTxt("p3","supportTips"), true));
    }
    if(pageData.id === "p4"){
       const ig = document.createElement("div"); ig.className="imgGrid";
       ig.appendChild(renderPhoto(f.photo1,"small",()=>editPhoto("p4","photo1")));
       ig.appendChild(renderPhoto(f.photo2,"small",()=>editPhoto("p4","photo2")));
       ig.appendChild(renderPhoto(f.photo3,"small",()=>editPhoto("p4","photo3")));
       inner.appendChild(ig);

       const tc = document.createElement("div"); tc.className="twoCol";
       tc.appendChild(renderBox("感覚（音・光・触覚）", f.sensory, "例文あり", ()=>editTxt("p4","sensory")));
       tc.appendChild(renderBox("生活（食事・排泄・着替え）", f.life, "例文あり", ()=>editTxt("p4","life")));
       tc.style.marginBottom="4mm";
       inner.appendChild(tc);
       inner.appendChild(renderBox("学習・手先の作業", f.learning, "例文あり", ()=>editTxt("p4","learning"), true));
       
       inner.appendChild(secTitle("学校生活の場面別"));
       const g = document.createElement("div"); g.className="twoCol";
       g.appendChild(renderBox("登校・朝の準備", f.schoolArrival, "例文あり", ()=>editTxt("p4","schoolArrival")));
       g.appendChild(renderBox("授業中", f.schoolClass, "例文あり", ()=>editTxt("p4","schoolClass")));
       g.appendChild(renderBox("休み時間", f.schoolRecess, "例文あり", ()=>editTxt("p4","schoolRecess")));
       g.appendChild(renderBox("下校・切り替え", f.schoolDismissal, "例文あり", ()=>editTxt("p4","schoolDismissal")));
       inner.appendChild(g);

       inner.appendChild(secTitle("パニック・不穏時"));
       inner.appendChild(renderBox("サイン・予兆", f.panicSigns, "例文あり", ()=>editTxt("p4","panicSigns"), true));
       inner.appendChild(renderBox("対応方法", f.panicSupport, "例文あり", ()=>editTxt("p4","panicSupport"), true));
    }
    if(pageData.id === "p5"){
      inner.appendChild(secTitle("具体的な場面と対応（リスト）"));
      
      const t = document.createElement("div"); t.className="table";
      const thead = document.createElement("div"); thead.className="trow";
      thead.innerHTML = `<div class="tcell">場面</div><div class="tcell">事実・困りごと</div><div class="tcell">お願いしたい対応</div>`;
      t.appendChild(thead);
      
      f.rows.forEach((r, idx)=>{
        const tr = document.createElement("div"); tr.className="trow";
        tr.appendChild(renderTCell(r.s, "場面", ()=>editRow(idx, "s")));
        tr.appendChild(renderTCell(r.f, "事実", ()=>editRow(idx, "f")));
        tr.appendChild(renderTCell(r.t, "対応", ()=>editRow(idx, "t")));
        t.appendChild(tr);
      });
      inner.appendChild(t);

      // 行追加削除ボタン（印刷時はCSSで消える）
      const acts = document.createElement("div"); acts.className="no-print"; acts.style.marginTop="5px";
      acts.innerHTML = `<button class="btn" onclick="addRow()">＋行を追加</button> <button class="btn" onclick="delRow()">−行を削除</button>`;
      inner.appendChild(acts);

      inner.appendChild(secTitle("先生へのメッセージ・補足写真"));
      inner.appendChild(renderBox("メッセージ", f.teacherMessage, "例文あり", ()=>editTxt("p5","teacherMessage"), true));
      
      const ig = document.createElement("div"); ig.className="imgGrid";
      ig.style.marginTop="4mm";
      ig.appendChild(renderPhoto(f.photo1,"small",()=>editPhoto("p5","photo1")));
      ig.appendChild(renderPhoto(f.photo2,"small",()=>editPhoto("p5","photo2")));
      ig.appendChild(renderPhoto(f.photo3,"small",()=>editPhoto("p5","photo3")));
      inner.appendChild(ig);
    }
  }

  return s;
}

/* Helpers */
function secTitle(t){ const d=document.createElement("div"); d.className="secTitle"; d.textContent=t; return d; }

function renderBox(lbl, val, hint, onClick, isWide){
  const d = document.createElement("div");
  d.className = "box" + (isWide?" wide":"");
  d.onclick = onClick;
  
  const l = document.createElement("div"); l.className="lbl"; l.textContent = lbl;
  d.appendChild(l);
  
  const v = document.createElement("div"); v.className="val";
  if(val){
    v.textContent = val;
  } else {
    // ヒントを表示（印刷時は消すためのクラスをつける）
    const s = document.createElement("span");
    s.className = "hint-text";
    s.textContent = hint;
    v.appendChild(s);
  }
  d.appendChild(v);
  return d;
}

function renderTCell(val, hint, onClick){
  const d = document.createElement("div"); d.className="tcell btncell";
  d.onclick = onClick;
  if(val) d.textContent = val;
  else d.innerHTML = `<span class="hint-text">${hint}</span>`;
  return d;
}

function renderPhoto(phObj, size, onClick){
  const d = document.createElement("div"); d.className="photoCard "+size;
  d.onclick = onClick;
  
  if(phObj.dataUrl){
    const img = document.createElement("img");
    img.src = phObj.dataUrl;
    // 簡易的な中央寄せスケール（本格的なエディタは省略）
    img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover";
    d.appendChild(img);
  } else {
    const p = document.createElement("div"); p.className="ph-placeholder";
    p.textContent = "写真を\n選択";
    d.appendChild(p);
  }
  
  const cap = document.createElement("div"); cap.className="cap";
  cap.innerHTML = `<span>${phObj.caption||""}</span><small>編集</small>`;
  d.appendChild(cap);
  
  return d;
}

/* --- 3. Interaction & Modal --- */
const modal = document.getElementById("modal");
const mBody = document.getElementById("modalBody");
let currentSaveAction = null;

function openModal(renderFn, onSave){
  mBody.innerHTML = "";
  mBody.appendChild(renderFn());
  currentSaveAction = onSave;
  modal.classList.add("show");
}
document.getElementById("btnCloseModal").onclick = ()=> modal.classList.remove("show");
document.getElementById("btnSaveField").onclick = ()=>{
  if(currentSaveAction) currentSaveAction();
  modal.classList.remove("show");
  render();
};

/* Edit Functions */
function editTxt(pgId, fieldKey){
  const page = state.pages.find(p=>p.id===pgId);
  openModal(()=>{
    const w = document.createElement("div");
    w.innerHTML = `<div style="font-weight:bold;margin-bottom:5px;">内容を入力</div>`;
    const ta = document.createElement("textarea");
    ta.id = "editorArea";
    ta.value = page.fields[fieldKey];
    w.appendChild(ta);
    // 例文ボタン用
    const ex = EXAMPLES[pgId]?.[fieldKey];
    document.getElementById("btnExample").style.display = ex ? "block" : "none";
    document.getElementById("btnExample").onclick = ()=> ta.value = ex;
    return w;
  }, ()=>{
    page.fields[fieldKey] = document.getElementById("editorArea").value;
  });
}

function editBirth(pgId){
  const page = state.pages.find(p=>p.id===pgId);
  openModal(()=>{
    const w = document.createElement("div");
    w.innerHTML = `
      <div style="margin-bottom:10px;"><label>生年月日</label><input type="date" id="inpBirth" style="width:100%;padding:8px;font-size:16px;" value="${page.fields.birth}"></div>
      <div><label>年齢</label><input type="number" id="inpAge" style="width:100%;padding:8px;font-size:16px;" value="${page.fields.age}"></div>
    `;
    document.getElementById("btnExample").style.display = "none";
    return w;
  }, ()=>{
    page.fields.birth = document.getElementById("inpBirth").value;
    page.fields.age = document.getElementById("inpAge").value;
  });
}

function editRow(rowIdx, key){
  const page = state.pages.find(p=>p.id==="p5");
  openModal(()=>{
    const val = page.fields.rows[rowIdx][key];
    const ta = document.createElement("textarea");
    ta.id = "editorArea";
    ta.value = val;
    document.getElementById("btnExample").style.display = "none";
    return ta;
  }, ()=>{
    page.fields.rows[rowIdx][key] = document.getElementById("editorArea").value;
  });
}

function addRow(){
  state.pages.find(p=>p.id==="p5").fields.rows.push({s:"",f:"",t:""});
  render();
}
function delRow(){
  const arr = state.pages.find(p=>p.id==="p5").fields.rows;
  if(arr.length>1) arr.pop();
  render();
}

/* Photo handling */
function editPhoto(pgId, key){
  const page = state.pages.find(p=>p.id===pgId);
  const fileInp = document.getElementById("photoFile");
  
  // スマホで写真を撮るか選ぶかを促す（簡易版：input click）
  fileInp.onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      page.fields[key].dataUrl = ev.target.result;
      render();
    };
    reader.readAsDataURL(file);
    fileInp.value = ""; // reset
  };
  
  // キャプション編集も含むか？今回は写真選択のみ
  if(confirm("写真を変更しますか？\n（キャンセルでキャプションのみ編集）")){
    fileInp.click();
  } else {
    const newCap = prompt("キャプションを入力", page.fields[key].caption);
    if(newCap!==null) {
      page.fields[key].caption = newCap;
      render();
    }
  }
}

/* --- 4. PDF Generation (Robust) --- */
const btnExport = document.getElementById("btnExportPdf");
const progress = document.getElementById("progress");
const pFill = document.getElementById("pFill");

btnExport.onclick = async () => {
  // Reset PrintHost
  printHost.innerHTML = "";
  
  progress.classList.add("show");
  pFill.style.width = "0%";
  
  // 1. 全ページをPrintHostにレンダリング
  // ※ここでレンダリングされる要素には .hint-text があるが、
  // html2canvas実行前にCSSで隠すか、レンダリング時に除外する必要がある。
  // 今回は @media print をJSからは利用できないため、
  // 手動でクラス制御を行うか、印刷用スタイルを強制適用する。
  
  // 全ページDOM作成
  state.pages.forEach(p => {
    const el = renderPage(p);
    // PDF生成用にスタイル調整（余計な影などを消す）
    el.style.border = "none";
    el.style.boxShadow = "none";
    el.style.marginBottom = "0";
    el.classList.add("for-pdf-gen"); // マーカークラス
    printHost.appendChild(el);
  });

  // 画像読み込み待ち（少し待機）
  await new Promise(r => setTimeout(r, 500));
  
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
    const sheets = printHost.querySelectorAll(".sheet");
    const count = sheets.length;
    
    // ヒント文字を一時的に消す処理
    const hints = printHost.querySelectorAll(".hint-text, .note, .no-print");
    hints.forEach(el => el.style.display = "none");
    
    // プレースホルダー写真の文字を薄くする
    const phs = printHost.querySelectorAll(".ph-placeholder");
    phs.forEach(el => { el.style.opacity = "0.1"; el.style.color = "transparent"; });

    for(let i=0; i<count; i++){
      pFill.style.width = Math.round(((i)/count)*100) + "%";
      
      const sheet = sheets[i];
      
      // html2canvasの設定（スマホ向けにscaleを抑える）
      const canvas = await html2canvas(sheet, {
        scale: 2, // 高すぎるとクラッシュする。2あれば十分綺麗
        useCORS: true,
        backgroundColor: "#ffffff",
        logging: false,
        width: 794, // A4 @ 96dpi approx (210mm)
        height: 1123,
        windowWidth: 794,
      });
      
      const imgData = canvas.toDataURL("image/jpeg", 0.9); // JPEG圧縮で軽量化
      
      if(i > 0) doc.addPage();
      doc.addImage(imgData, 'JPEG', 0, 0, 210, 297);
      
      // メモリ解放待機
      await new Promise(r => setTimeout(r, 50));
    }
    
    pFill.style.width = "100%";
    
    // 保存
    const date = new Date().toISOString().slice(0,10);
    doc.save(`support_book_${date}.pdf`);
    
  } catch(e) {
    alert("PDF作成に失敗しました。\n写真のサイズが大きすぎる可能性があります。\n" + e.message);
    console.error(e);
  } finally {
    progress.classList.remove("show");
    printHost.innerHTML = ""; // cleanup
  }
};

/* Utils */
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
document.getElementById("btnReset").onclick = ()=>{
  if(confirm("全データを消去してリセットしますか？")) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
};

// Initial Render
render();

</script>
</body>
</html>
