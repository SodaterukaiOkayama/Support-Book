<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆãƒ„ãƒ¼ãƒ«ï¼ˆå®Œå…¨ç‰ˆãƒ»ã‚¹ãƒãƒ›å¯¾å¿œï¼‰</title>

<style>
  :root{
    --a4-w: 210mm;
    --a4-h: 297mm;
    --stroke: rgba(15,23,42,0.14);
    --text: #0b1220;
    --muted: rgba(15,23,42,0.64);
    --accent: #2563eb;
    --accent2:#7c3aed;
    --sheet-scale: 0.42;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Segoe UI", sans-serif;
    color:var(--text);
    background:#f1f5f9;
  }

  /* UIè¦ç´  */
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--stroke);
    padding:10px 12px;
    display:flex; justify-content:space-between; align-items:center;
  }
  .hdr-right{ display:flex; gap:8px; flex-wrap:wrap; }
  
  .btn{
    border:1px solid var(--stroke); background:#fff;
    padding:8px 10px; border-radius:10px; font-size:13px;
    font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
  }
  .btn.primary{
    background:linear-gradient(135deg,var(--accent), var(--accent2));
    color:#fff; border-color:transparent;
  }

  main{ padding:12px; display:flex; flex-direction:column; align-items:center; gap:10px; }

  .tabs{ display:flex; gap:6px; overflow:auto; padding:6px 2px; width:100%; max-width:520px; }
  .tab{
    flex:0 0 auto; border:1px solid var(--stroke); background:#fff;
    padding:8px 12px; border-radius:999px; font-size:12px; cursor:pointer;
  }
  .tab.active{ background: rgba(37,99,235,0.12); color:#1d4ed8; font-weight:900; }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
  .stage{ width: min(96vw, 520px); display:flex; justify-content:center; }
  .sheet-wrap{ transform: scale(var(--sheet-scale)); transform-origin: top center; width: var(--a4-w); }

  /* A4ã‚·ãƒ¼ãƒˆæœ¬ä½“ */
  .sheet{
    width: var(--a4-w); height: var(--a4-h);
    background:#fff; position:relative; overflow:hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  .sheet-inner{ position:absolute; inset:0; padding:10mm; display:flex; flex-direction:column; gap:5mm; }

  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‘ãƒ¼ãƒ„ */
  .h1{ font-size:22px; font-weight:900; }
  .meta{ display:flex; gap:6mm; }
  .photoCard{
    border:1px solid var(--stroke); border-radius:12px; overflow:hidden;
    position:relative; background:#f8fafc; cursor:pointer;
  }
  .photoCard.large{ width: 58mm; height: 74mm; flex:0 0 auto; }
  .photoCard.small{ width: 40mm; height: 30mm; }
  .photoCard img{ position:absolute; transform-origin: center; pointer-events:none; }
  .photoCard .ph-text{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    color:#9aa3af; font-size:11px; text-align:center;
  }
  .photoCard .cap{
    position:absolute; left:0; right:0; bottom:0; padding:4px 8px;
    background:rgba(255,255,255,0.8); font-size:11px; font-weight:bold;
  }

  .infoGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:4mm; flex:1; }
  .box{
    border:1px solid var(--stroke); border-radius:12px; padding:8px;
    background:#fff; min-height: 18mm; cursor:pointer;
  }
  .box.wide{ grid-column: 1 / -1; }
  .lbl{ font-size:10px; color:var(--muted); font-weight:bold; margin-bottom:4px; }
  .val{ font-size:12px; line-height:1.4; white-space:pre-wrap; }

  /* å°åˆ·ãƒ»PDFæ™‚ã«æ¶ˆã™è¦ç´  */
  .hint-text { color: #cbd5e1; font-style: italic; }
  @media print {
    .no-print, .hint-text, .btn, .tabs, header { display: none !important; }
    body { background: white; }
    .sheet { box-shadow: none; margin: 0; page-break-after: always; }
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table{ border:1px solid var(--stroke); border-radius:12px; overflow:hidden; }
  .trow{ display:grid; grid-template-columns: 25% 37.5% 37.5%; border-top:1px solid var(--stroke); }
  .thead{ background:rgba(37,99,235,0.05); font-weight:bold; border-top:none; }
  .tcell{ padding:8px; font-size:11px; min-height: 14mm; }

  /* é€²æ— */
  #progress{
    position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200;
    display:none; flex-direction:column; align-items:center; justify-content:center; color:#fff;
  }
  .p-bar{ width:200px; height:8px; background:#333; border-radius:4px; margin-top:10px; overflow:hidden; }
  .p-fill{ height:100%; background:var(--accent); width:0%; transition: width 0.3s; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100;
    display:none; align-items:flex-end; justify-content:center;
  }
  .modal.show{ display:flex; }
  .sheetModal{
    width:min(100vw, 600px); background:#fff; border-radius:20px 20px 0 0;
    padding:20px; display:flex; flex-direction:column; gap:15px;
    max-height: 90vh; overflow-y: auto;
  }
  textarea{ width:100%; min-height:150px; padding:12px; border:1px solid var(--stroke); border-radius:12px; font-size:16px; }

  /* å†™çœŸã‚¨ãƒ‡ã‚£ã‚¿ãƒ„ãƒ¼ãƒ« */
  .photo-tools{ display:flex; gap:10px; flex-wrap:wrap; background:#f8fafc; padding:10px; border-radius:12px; }

  /* PDFç”Ÿæˆç”¨ã®éš ã—ãƒãƒƒãƒ•ã‚¡ */
  #pdf-buffer { position: absolute; left: -9999px; top: 0; width: var(--a4-w); }
</style>
</head>
<body>

<header class="no-print">
  <div>
    <div style="font-weight:900; font-size:14px;">ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆ</div>
    <div style="font-size:10px; color:var(--muted);">ã‚¹ãƒãƒ›å¯¾å¿œãƒ»é«˜å“è³ªPDFä¿å­˜</div>
  </div>
  <div class="hdr-right">
    <button class="btn primary" id="btnPdf">PDFä¿å­˜ / å…±æœ‰</button>
    <button class="btn" id="btnData">ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
  </div>
</header>

<main class="no-print">
  <div class="tabs" id="tabs"></div>
  <div class="stage" id="stage"></div>
</main>

<div id="pdf-buffer"></div>

<div id="progress">
  <div id="p-text">PDFã‚’ä½œæˆä¸­...</div>
  <div class="p-bar"><div class="p-fill" id="p-fill"></div></div>
</div>

<div class="modal" id="modal">
  <div class="sheetModal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <b id="modalTitle">å…¥åŠ›</b>
      <button class="btn" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
    <div id="modalBody"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn" id="btnExample">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
      <button class="btn primary" id="btnSave">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* --- ãƒ‡ãƒ¼ã‚¿æ§‹æˆ (å®Œå…¨å¾©æ´») --- */
const STORAGE_KEY = "support_book_v3_full";
const TEMPLATE = {
  pages: [
    { id:"p1", title:"è¡¨ç´™", fields: {
      updatedDate:"", childName:"", nickname:"", birth:"", age:"", diagnosis:"", messageShort:"",
      photoMain:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"æœ¬äººã®å†™çœŸ" },
      photoSub1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å¥½ããªã‚‚ã®" },
      photoSub2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å®‰å¿ƒã‚°ãƒƒã‚º" }
    }},
    { id:"p2", title:"å¼·ã¿ãƒ»å¥½ã", fields: {
      strengths:"", interests:"", triggers:"", calming:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å¾—æ„ãªã“ã¨" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å¥½ããªã“ã¨" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"è½ã¡ç€ãå ´æ‰€" }
    }},
    { id:"p3", title:"ä¼ãˆæ–¹", fields: {
      understand:"", express:"", supportTips:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"è¦–è¦šæ”¯æ´" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"è¦‹æœ¬" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"ãƒ«ãƒ¼ãƒ«" }
    }},
    { id:"p4", title:"å­¦æ ¡ãƒ»é…æ…®", fields: {
      sensory:"", life:"", learning:"", schoolArrival:"", schoolClass:"", schoolRecess:"", schoolDismissal:"",
      panicSigns:"", panicSupport:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"é…æ…®ã®ä¾‹" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"ãã®ä»–" }
    }},
    { id:"p5", title:"å ´é¢åˆ¥ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", fields: {
      rows:[
        {scene:"äºˆå®šã®å¤‰æ›´", fact:"", support:""},
        {scene:"æŒ‡ç¤ºã®ç†è§£", fact:"", support:""},
        {scene:"éŸ³ã®éæ•", fact:"", support:""},
        {scene:"å‹é”é–¢ä¿‚", fact:"", support:""},
      ],
      teacherMessage:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"æŒã¡ç‰©" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"é€£çµ¡æ–¹æ³•" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"é…å¸ƒç‰©" }
    }}
  ]
};

const EXAMPLES = {
  p1: { messageShort:"åˆã‚ã¦ã®ç’°å¢ƒã§ä¸å®‰ã‚‚ã‚ã‚Šã¾ã™ãŒã€æœ¬äººã®ãƒšãƒ¼ã‚¹ã§æ…£ã‚Œã¦ã„ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚" },
  p2: { strengths:"ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ã€é›†ä¸­åŠ›ãŒã‚ã‚‹", interests:"é›»è»Šã€æ•°å­—ã€æŠ˜ã‚Šç´™", triggers:"å¤§ããªéŸ³ã€æ€¥ãªå¤‰æ›´", calming:"ã‚¤ãƒ¤ãƒ¼ãƒãƒ•ã€é™ã‹ãªå ´æ‰€" },
  p3: { understand:"çŸ­ã„è¨€è‘‰ã§ä¼ãˆã‚‹ã€‚è¦–è¦šæç¤ºãŒæœ‰åŠ¹ã€‚", express:"å›°ã£ã¦ã„ã¦ã‚‚è¨€ãˆãªã„ã€‚äºŒæŠã§èãã¨ç­”ãˆã‚„ã™ã„ã€‚", supportTips:"æŒ‡ç¤ºã®å¾Œã«å€‹åˆ¥ã«ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚" },
  p4: { sensory:"ãƒãƒ£ã‚¤ãƒ ãŒè‹¦æ‰‹ã€‚", learning:"æ‰‹å…ˆãŒä¸å™¨ç”¨ã€‚è£œåŠ©ã‚’å¸Œæœ›ã€‚", panicSigns:"ç‹¬ã‚Šè¨€ãŒå¢—ãˆã‚‹", panicSupport:"åˆºæ¿€ã‚’æ¸›ã‚‰ã—ã¦è¦‹å®ˆã‚‹" },
  p5: { teacherMessage:"æœ¬äººãŒæ¥½ã—ãç™»æ ¡ã§ãã‚‹ã‚ˆã†ã€é€£æºã•ã›ã¦ãã ã•ã„ã€‚" }
};

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || JSON.parse(JSON.stringify(TEMPLATE));
let currentPage = 0;

/* --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° --- */
function render(){
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";
  state.pages.forEach((p, i)=>{
    const btn = document.createElement("div");
    btn.className = `tab ${i===currentPage?'active':''}`;
    btn.textContent = p.title;
    btn.onclick = () => { currentPage=i; render(); };
    tabs.appendChild(btn);
  });

  const stage = document.getElementById("stage");
  stage.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "sheet-wrap";
  wrap.appendChild(createPageDOM(currentPage, false));
  stage.appendChild(wrap);

  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function createPageDOM(idx, isForPdf){
  const data = state.pages[idx];
  const sheet = document.createElement("div");
  sheet.className = "sheet";
  const inner = document.createElement("div");
  inner.className = "sheet-inner";
  sheet.appendChild(inner);

  const f = data.fields;

  if(data.id === "p1"){
    inner.innerHTML = `<div class="h1">ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯</div><div style="font-size:11px; color:var(--muted); margin-top:-4mm;">â€»ã“ã®å­ã®å®‰å¿ƒã®ãŸã‚ã®å–ã‚Šæ‰±ã„èª¬æ˜æ›¸</div>`;
    const m = document.createElement("div"); m.className = "meta";
    m.appendChild(renderPhoto(f.photoMain, "large", idx, "photoMain"));
    const g = document.createElement("div"); g.className="infoGrid";
    g.appendChild(renderBox("æ›´æ–°æ—¥", f.updatedDate, "2024/04/01", idx, "updatedDate"));
    g.appendChild(renderBox("æ°å", f.childName, "ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›", idx, "childName"));
    g.appendChild(renderBox("æ„›ç§°", f.nickname, "ã€‡ã€‡ãã‚“ã€ãªã©", idx, "nickname"));
    g.appendChild(renderBox("ç”Ÿå¹´æœˆæ—¥/å¹´é½¢", f.birth + (f.age?` (${f.age}æ­³)`:''), "ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›", idx, "birth"));
    g.appendChild(renderBox("è¨ºæ–­å(ä»»æ„)", f.diagnosis, "ä»»æ„å…¥åŠ›", idx, "diagnosis"));
    g.appendChild(renderBox("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", f.messageShort, "ä¾‹æ–‡ã‚ã‚Š", idx, "messageShort", true));
    m.appendChild(g);
    inner.appendChild(m);
    inner.innerHTML += `<div style="font-size:13px; font-weight:900; border-bottom:1px solid #eee; margin-top:2mm;">ğŸ“¸ å†™çœŸï¼ˆå¥½ããªã‚‚ã®ãƒ»å®‰å¿ƒã‚°ãƒƒã‚ºï¼‰</div>`;
    const r = document.createElement("div"); r.className="meta";
    r.appendChild(renderPhoto(f.photoSub1, "small", idx, "photoSub1"));
    r.appendChild(renderPhoto(f.photoSub2, "small", idx, "photoSub2"));
    inner.appendChild(r);
  } else if(data.id === "p2"){
    inner.innerHTML = `<div class="h1">ğŸŒŸ ${data.title}</div>`;
    const ig = document.createElement("div"); ig.className="meta";
    ig.appendChild(renderPhoto(f.photo1,"small",idx,"photo1"));
    ig.appendChild(renderPhoto(f.photo2,"small",idx,"photo2"));
    ig.appendChild(renderPhoto(f.photo3,"small",idx,"photo3"));
    inner.appendChild(ig);
    inner.appendChild(renderBox("å¼·ã¿ãƒ»å¾—æ„", f.strengths, "ä¾‹æ–‡ã‚ã‚Š", idx, "strengths", true));
    inner.appendChild(renderBox("èˆˆå‘³ãƒ»å¥½ã", f.interests, "ä¾‹æ–‡ã‚ã‚Š", idx, "interests", true));
    const tc = document.createElement("div"); tc.className="meta";
    tc.appendChild(renderBox("è‹¦æ‰‹(äº‹å®Ÿ)", f.triggers, "ä¾‹æ–‡ã‚ã‚Š", idx, "triggers", false));
    tc.appendChild(renderBox("è½ã¡ç€ãæ–¹æ³•(å¯¾ç­–)", f.calming, "ä¾‹æ–‡ã‚ã‚Š", idx, "calming", false));
    inner.appendChild(tc);
  } else if(data.id === "p3"){
    inner.innerHTML = `<div class="h1">ğŸ“¢ ${data.title}</div>`;
    const ig = document.createElement("div"); ig.className="meta";
    ig.appendChild(renderPhoto(f.photo1,"small",idx,"photo1"));
    ig.appendChild(renderPhoto(f.photo2,"small",idx,"photo2"));
    ig.appendChild(renderPhoto(f.photo3,"small",idx,"photo3"));
    inner.appendChild(ig);
    inner.appendChild(renderBox("åˆ†ã‹ã‚Šã‚„ã™ã„ä¼ãˆæ–¹", f.understand, "ä¾‹æ–‡ã‚ã‚Š", idx, "understand", true));
    inner.appendChild(renderBox("æœ¬äººã®ä¼ãˆæ–¹", f.express, "ä¾‹æ–‡ã‚ã‚Š", idx, "express", true));
    inner.appendChild(renderBox("æ”¯æ´ã®ãƒ’ãƒ³ãƒˆ", f.supportTips, "ä¾‹æ–‡ã‚ã‚Š", idx, "supportTips", true));
  } else if(data.id === "p4"){
    inner.innerHTML = `<div class="h1">ğŸ« ${data.title}</div>`;
    const ig = document.createElement("div"); ig.className="meta";
    ig.appendChild(renderPhoto(f.photo1,"small",idx,"photo1"));
    ig.appendChild(renderPhoto(f.photo2,"small",idx,"photo2"));
    ig.appendChild(renderPhoto(f.photo3,"small",idx,"photo3"));
    inner.appendChild(ig);
    const tc = document.createElement("div"); tc.className="meta";
    tc.appendChild(renderBox("æ„Ÿè¦š(éŸ³ãƒ»å…‰)", f.sensory, "ä¾‹æ–‡ã‚ã‚Š", idx, "sensory"));
    tc.appendChild(renderBox("ç”Ÿæ´»(çµ¦é£Ÿãƒ»æ’æ³„)", f.life, "ä¾‹æ–‡ã‚ã‚Š", idx, "life"));
    inner.appendChild(tc);
    inner.appendChild(renderBox("å­¦ç¿’é¢", f.learning, "ä¾‹æ–‡ã‚ã‚Š", idx, "learning", true));
    const sc = document.createElement("div"); sc.className="infoGrid";
    sc.appendChild(renderBox("ç™»æ ¡ãƒ»æº–å‚™", f.schoolArrival, "ä¾‹æ–‡ã‚ã‚Š", idx, "schoolArrival"));
    sc.appendChild(renderBox("æˆæ¥­ä¸­", f.schoolClass, "ä¾‹æ–‡ã‚ã‚Š", idx, "schoolClass"));
    sc.appendChild(renderBox("ä¼‘ã¿æ™‚é–“", f.schoolRecess, "ä¾‹æ–‡ã‚ã‚Š", idx, "schoolRecess"));
    sc.appendChild(renderBox("ä¸‹æ ¡ãƒ»åˆ‡ã‚Šæ›¿ãˆ", f.schoolDismissal, "ä¾‹æ–‡ã‚ã‚Š", idx, "schoolDismissal"));
    inner.appendChild(sc);
    inner.appendChild(renderBox("ãƒ‘ãƒ‹ãƒƒã‚¯äºˆå…†", f.panicSigns, "ä¾‹æ–‡ã‚ã‚Š", idx, "panicSigns", true));
    inner.appendChild(renderBox("ãƒ‘ãƒ‹ãƒƒã‚¯æ™‚å¯¾å¿œ", f.panicSupport, "ä¾‹æ–‡ã‚ã‚Š", idx, "panicSupport", true));
  } else if(data.id === "p5"){
    inner.innerHTML = `<div class="h1">ğŸ“ ${data.title}</div>`;
    const t = document.createElement("div"); t.className="table";
    t.innerHTML = `<div class="trow thead"><div class="tcell">å ´é¢</div><div class="tcell">å›°ã‚Šã”ã¨</div><div class="tcell">ãŠé¡˜ã„</div></div>`;
    f.rows.forEach((r,ri)=>{
      const row = document.createElement("div"); row.className="trow";
      row.appendChild(renderTCell(r.scene, "ä¾‹:äºˆå®šå¤‰æ›´", idx, `rows.${ri}.scene`));
      row.appendChild(renderTCell(r.fact, "å›°ã‚‹äº‹", idx, `rows.${ri}.fact`));
      row.appendChild(renderTCell(r.support, "å¯¾å¿œç­–", idx, `rows.${ri}.support`));
      t.appendChild(row);
    });
    inner.appendChild(t);
    inner.appendChild(renderBox("å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", f.teacherMessage, "ä¾‹æ–‡ã‚ã‚Š", idx, "teacherMessage", true));
    const ig = document.createElement("div"); ig.className="meta";
    ig.appendChild(renderPhoto(f.photo1,"small",idx,"photo1"));
    ig.appendChild(renderPhoto(f.photo2,"small",idx,"photo2"));
    ig.appendChild(renderPhoto(f.photo3,"small",idx,"photo3"));
    inner.appendChild(ig);
  }

  // PDFç”¨ãªã‚‰ãƒ’ãƒ³ãƒˆæ–‡å­—ã‚’å¼·åˆ¶å‰Šé™¤
  if(isForPdf){
    sheet.querySelectorAll(".hint-text").forEach(el => el.remove());
  }

  return sheet;
}

function renderBox(lbl, val, hint, pIdx, key, wide){
  const b = document.createElement("div");
  b.className = "box " + (wide?"wide":"");
  b.onclick = () => openTextModal(pIdx, key);
  b.innerHTML = `<div class="lbl">${lbl}</div><div class="val">${val || `<span class="hint-text">${hint}</span>`}</div>`;
  return b;
}

function renderTCell(val, hint, pIdx, key){
  const c = document.createElement("div"); c.className="tcell";
  c.onclick = () => openTextModal(pIdx, key);
  c.innerHTML = val || `<span class="hint-text">${hint}</span>`;
  return c;
}

function renderPhoto(ph, size, pIdx, key){
  const c = document.createElement("div");
  c.className = "photoCard "+size;
  c.onclick = () => openPhotoModal(pIdx, key);
  if(ph.dataUrl){
    const img = document.createElement("img");
    img.src = ph.dataUrl;
    img.style.left = `calc(50% + ${ph.x}px)`;
    img.style.top = `calc(50% + ${ph.y}px)`;
    img.style.transform = `translate(-50%, -50%) rotate(${ph.rot}deg) scale(${ph.scale})`;
    img.style.width = "100%";
    c.appendChild(img);
  } else {
    c.innerHTML = `<div class="ph-text">ã‚¿ãƒƒãƒ—ã—ã¦<br>å†™çœŸé¸æŠ</div>`;
  }
  c.innerHTML += `<div class="cap">${ph.caption}</div>`;
  return c;
}

/* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ç·¨é›† --- */
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modalBody");
const btnSave = document.getElementById("btnSave");
const btnExample = document.getElementById("btnExample");

function openTextModal(pIdx, key){
  const p = state.pages[pIdx];
  let val = "";
  if(key.includes("rows")){
    const parts = key.split(".");
    val = p.fields.rows[parts[1]][parts[2]];
  } else {
    val = p.fields[key];
  }

  modalBody.innerHTML = `<textarea id="m-ta">${val}</textarea>`;
  btnExample.style.display = EXAMPLES[p.id]?.[key] ? "block" : "none";
  btnExample.onclick = () => { document.getElementById("m-ta").value = EXAMPLES[p.id][key]; };
  
  btnSave.onclick = () => {
    const newV = document.getElementById("m-ta").value;
    if(key.includes("rows")){
      const parts = key.split(".");
      p.fields.rows[parts[1]][parts[2]] = newV;
    } else {
      p.fields[key] = newV;
    }
    closeModal();
  };
  modal.classList.add("show");
}

function openPhotoModal(pIdx, key){
  const ph = state.pages[pIdx].fields[key];
  modalBody.innerHTML = `
    <div class="photo-tools">
      <button class="btn" id="btn-file">ğŸ“· å†™çœŸã‚’é¸æŠ</button>
      <button class="btn" id="btn-rot">ğŸ”„ 90Â°å›è»¢</button>
      <button class="btn" id="btn-zoom-in">â• æ‹¡å¤§</button>
      <button class="btn" id="btn-zoom-out">â– ç¸®å°</button>
    </div>
    <div style="font-size:12px; color:var(--muted); margin-top:5px;">â€»ãƒ‰ãƒ©ãƒƒã‚°ã‚„ãƒ”ãƒ³ãƒæ“ä½œã®ä»£ã‚ã‚Šã«ä¸Šã®ãƒœã‚¿ãƒ³ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</div>
    <div style="margin-top:10px;">
      <label class="lbl">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</label>
      <input type="text" id="m-cap" value="${ph.caption}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;">
    </div>
  `;
  document.getElementById("btn-file").onclick = () => {
    const inp = document.getElementById("fileInput");
    inp.onchange = (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = (re) => { ph.dataUrl = re.target.result; closeModal(); render(); };
      reader.readAsDataURL(file);
    };
    inp.click();
  };
  document.getElementById("btn-rot").onclick = () => { ph.rot = (ph.rot + 90) % 360; };
  document.getElementById("btn-zoom-in").onclick = () => { ph.scale += 0.1; };
  document.getElementById("btn-zoom-out").onclick = () => { ph.scale = Math.max(0.1, ph.scale - 0.1); };
  
  btnExample.style.display = "none";
  btnSave.onclick = () => {
    ph.caption = document.getElementById("m-cap").value;
    closeModal();
  };
  modal.classList.add("show");
}

function closeModal(){ modal.classList.remove("show"); render(); }

/* --- PDFç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ (ã‚¹ãƒãƒ›ç‰¹åŒ–) --- */
document.getElementById("btnPdf").onclick = async () => {
  const prog = document.getElementById("progress");
  const pFill = document.getElementById("p-fill");
  const pText = document.getElementById("p-text");
  const buffer = document.getElementById("pdf-buffer");
  
  prog.style.display = "flex";
  pFill.style.width = "0%";
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  
  for(let i=0; i<state.pages.length; i++){
    pText.textContent = `ãƒšãƒ¼ã‚¸ ${i+1} / ${state.pages.length} ã‚’ä½œæˆä¸­...`;
    pFill.style.width = `${((i+1)/state.pages.length)*100}%`;
    
    // ãƒãƒƒãƒ•ã‚¡ã«ãƒšãƒ¼ã‚¸ã‚’é…ç½®ï¼ˆ1æšãšã¤ä¸å¯§ã«ï¼‰
    buffer.innerHTML = "";
    const pageDom = createPageDOM(i, true); // PDFå°‚ç”¨DOMï¼ˆãƒ’ãƒ³ãƒˆæ–‡å­—ãªã—ï¼‰
    buffer.appendChild(pageDom);
    
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾…æ©Ÿ
    await new Promise(r => setTimeout(r, 400));
    
    const canvas = await html2canvas(pageDom, {
      scale: 2, // 2ã§ååˆ†ç¶ºéº—
      useCORS: true,
      logging: false,
      backgroundColor: "#ffffff",
      width: 793, // 210mm at 96dpi
      height: 1122 // 297mm at 96dpi
    });
    
    const imgData = canvas.toDataURL("image/jpeg", 0.9);
    if(i > 0) pdf.addPage();
    pdf.addImage(imgData, "JPEG", 0, 0, 210, 297);
    
    buffer.innerHTML = ""; // ãƒ¡ãƒ¢ãƒªè§£æ”¾
  }
  
  const fileName = `support_book_${new Date().getTime()}.pdf`;
  const blob = pdf.output("blob");
  const file = new File([blob], fileName, { type: "application/pdf" });

  prog.style.display = "none";

  // ã‚¹ãƒãƒ›ã®å…±æœ‰æ©Ÿèƒ½(Web Share API)ã‚’å„ªå…ˆä½¿ç”¨
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({
        files: [file],
        title: "ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯",
        text: "ä½œæˆã—ãŸã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®PDFã§ã™ã€‚"
      });
    } catch (err) {
      pdf.save(fileName); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ãªã©ã¯æ™®é€šã«ä¿å­˜
    }
  } else {
    pdf.save(fileName);
  }
};

/* --- åˆæœŸåŒ– --- */
document.getElementById("btnData").onclick = () => {
  const dataStr = JSON.stringify(state);
  const blob = new Blob([dataStr], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "support_book_data.json"; a.click();
};

render();
</script>
</body>
</html>
