<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆãƒ„ãƒ¼ãƒ«ï¼ˆã‚¹ãƒãƒ›PDFå®‰å®šç‰ˆï¼‰</title>

<style>
  :root{
    --a4-w: 210mm;
    --a4-h: 297mm;

    --stroke: rgba(15,23,42,0.14);
    --text: #0b1220;
    --muted: rgba(15,23,42,0.64);

    --accent: #2563eb;
    --accent2:#7c3aed;

    --sheet-scale: 0.42;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Segoe UI", sans-serif;
    color:var(--text);
    background:#f1f5f9;
    display:flex;
    flex-direction:column;
    height:100vh;
  }

  header{
    position:sticky; top:0; z-index:50;
    background:#fff;
    border-bottom:1px solid var(--stroke);
    padding:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .hdr-title{
    font-weight:900;
    font-size:14px;
    line-height:1.2;
  }
  .hdr-sub{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }
  .hdr-right{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }

  .btn{
    border:1px solid var(--stroke);
    background:#fff;
    padding:8px 12px;
    border-radius:10px;
    font-size:13px;
    font-weight:800;
    cursor:pointer;
    user-select:none;
  }
  .btn.primary{
    background:linear-gradient(135deg,var(--accent), var(--accent2));
    color:#fff;
    border:none;
  }
  .btn:active{ transform: translateY(1px); }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  main{
    flex:1;
    overflow-y:auto;
    padding:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }

  .tabs{
    display:flex;
    gap:5px;
    overflow-x:auto;
    width:100%;
    max-width:520px;
    padding:5px 2px;
  }
  .tab{
    flex:0 0 auto;
    padding:8px 14px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:#fff;
    white-space:nowrap;
    font-size:12px;
    cursor:pointer;
    font-weight:800;
  }
  .tab.active{
    background:var(--accent);
    color:#fff;
    border-color:var(--accent);
  }

  /* Preview */
  .stage{ width: min(96vw, 520px); display:flex; justify-content:center; }
  .sheet-wrap{ transform: scale(var(--sheet-scale)); transform-origin: top center; width: var(--a4-w); }
  .sheet{
    width: var(--a4-w);
    height: var(--a4-h);
    background:#fff;
    position:relative;
    overflow:hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.10);
    border:1px solid rgba(2,6,23,0.10);
    border-radius: 12px;
  }
  .sheet-inner{
    position:absolute; inset:0;
    padding:10mm;
    display:flex;
    flex-direction:column;
    gap:5mm;
  }

  /* Components */
  .secTitle{
    font-size:14px;
    font-weight:1000;
    margin:0;
  }
  .h1{ font-size:22px; font-weight:1000; margin:0; }
  .note{ font-size:11px; color:var(--muted); line-height:1.35; }

  .meta{ display:flex; gap:5mm; align-items:flex-start; }

  .photoCard{
    border:1px solid var(--stroke);
    border-radius:12px;
    overflow:hidden;
    position:relative;
    background:#f8fafc;
    cursor:pointer;
  }
  .photoCard.large{ width: 58mm; height: 74mm; flex:0 0 auto; }
  .photoCard.small{ width: 40mm; height: 30mm; flex:0 0 auto; }
  .photoCard img{
    position:absolute;
    left:50%;
    top:50%;
    width:120%;
    height:auto;
    transform-origin:center;
    pointer-events:none;
    user-select:none;
    -webkit-user-drag:none;
  }
  .photoCard .ph{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    color:#cbd5e1;
    font-weight:900;
    font-size:10px;
    text-align:center;
    padding:8px;
    white-space:pre-line;
  }
  .photoCard .cap{
    position:absolute;
    bottom:0;
    width:100%;
    background:rgba(255,255,255,0.85);
    font-size:10px;
    padding:3px 6px;
    text-align:center;
    font-weight:900;
    color:#0b1220;
  }

  .infoGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:4mm;
    flex:1;
  }
  .box{
    border:1px solid var(--stroke);
    border-radius:10px;
    padding:8px;
    background:#fff;
    min-height:16mm;
    cursor:pointer;
  }
  .box.wide{ grid-column: 1 / -1; }
  .lbl{ font-size:10px; color:var(--muted); font-weight:900; }
  .val{ font-size:12px; white-space:pre-wrap; margin-top:2px; line-height:1.35; word-break:break-word; }
  .hint{ color:#cbd5e1; font-style:italic; font-weight:700; }

  /* Table */
  .table{ border:1px solid var(--stroke); border-radius:10px; overflow:hidden; width:100%; background:#fff; }
  .trow{ display:grid; grid-template-columns: 25% 37.5% 37.5%; border-top:1px solid var(--stroke); }
  .thead{ background:#f8fafc; font-weight:1000; border-top:none; }
  .tcell{ padding:8px; font-size:11px; min-height:12mm; word-break:break-word; cursor:pointer; line-height:1.35; }

  /* Modal */
  .modal{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.5);
    z-index:100;
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .modal.show{ display:flex; }
  .m-content{
    background:#fff;
    width:100%;
    max-width:520px;
    border-radius:15px;
    padding:16px;
    max-height:90vh;
    overflow-y:auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  }
  .m-content h3{
    margin:0 0 10px 0;
    font-size:14px;
    font-weight:1000;
  }
  textarea, input[type="text"]{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid rgba(15,23,42,0.18);
    font-size:16px;
    font-family: inherit;
    outline:none;
  }
  textarea{ min-height:140px; resize:vertical; }

  /* Photo editor */
  .editor-canvas{
    width:100%;
    height:260px;
    background:#111827;
    position:relative;
    overflow:hidden;
    border-radius:12px;
    touch-action:none;
    border:1px solid rgba(255,255,255,0.12);
  }
  .editor-canvas img{
    position:absolute;
    left:50%;
    top:50%;
    width:120%;
    height:auto;
    transform-origin:center;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;
  }
  .controls{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:6px;
    margin-top:10px;
  }
  .controls .btn{ padding:10px 8px; font-size:12px; }

  /* Progress overlay (good part from your code) */
  #progress{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.82);
    color:#fff;
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:200;
    padding:20px;
    text-align:center;
  }
  #p-text{ font-weight:900; font-size:14px; }
  #p-sub{ margin-top:8px; font-size:12px; opacity:0.9; }
  .p-wrap{
    width:min(320px, 80vw);
    height:10px;
    background:#374151;
    border-radius:999px;
    margin-top:14px;
    overflow:hidden;
  }
  #p-bar{
    width:0%;
    height:100%;
    background:var(--accent);
    transition:0.25s;
  }

  /* Hidden export container */
  #exportHost{
    position:absolute;
    left:-99999px;
    top:0;
    width: var(--a4-w);
    height:auto;
    visibility:hidden;
    pointer-events:none;
  }

  /* Print CSS */
  @page { size:A4 portrait; margin:0; }
  @media print{
    header, main, #progress, .modal{ display:none !important; }
    #printHost{
      display:block !important;
      visibility: visible !important;
      position:static !important;
      left:auto !important;
      top:auto !important;
      width:auto !important;
      height:auto !important;
      overflow:visible !important;
    }
    .sheet-wrap{ transform:none !important; }
    .sheet{
      border:none !important;
      border-radius:0 !important;
      box-shadow:none !important;
      width: var(--a4-w) !important;
      height: var(--a4-h) !important;
      page-break-after: always;
      break-after: page;
    }
    .sheet:last-child{ page-break-after:auto; break-after:auto; }
  }
</style>
</head>

<body>

<header>
  <div>
    <div class="hdr-title">ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆ</div>
    <div class="hdr-sub">PC=å°åˆ· / ã‚¹ãƒãƒ›=PDFä¿å­˜ãƒ»å…±æœ‰ï¼ˆ1ãƒœã‚¿ãƒ³ï¼‰</div>
  </div>
  <div class="hdr-right">
    <button class="btn primary" id="btnPrintPdf">å°åˆ· / PDF</button>
    <button class="btn" id="btnExport">ä¿å­˜</button>
    <button class="btn" id="btnImport">èª­è¾¼</button>
    <button class="btn" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</header>

<main>
  <div class="tabs" id="tabs"></div>
  <div class="stage" id="stage"></div>
</main>

<div id="progress">
  <div id="p-text">PDFä½œæˆä¸­...</div>
  <div id="p-sub">ç”»åƒãŒå¤šã„ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</div>
  <div class="p-wrap"><div id="p-bar"></div></div>
</div>

<div class="modal" id="modal">
  <div class="m-content" id="m-content"></div>
</div>

<div id="exportHost"></div>
<div id="printHost" style="display:none"></div>

<input type="file" id="fileInput" accept="image/*" style="display:none">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* =========================
   åŸºæœ¬
========================= */
const STORAGE_KEY = "support_book_pdf_stable_v2";

const TEMPLATE = {
  pages: [
    { id:"p1", title:"è¡¨ç´™", fields: {
      updatedDate:"", childName:"", nickname:"", birth:"", age:"", diagnosis:"", messageShort:"",
      photoMain:{ src:"", s:1, x:0, y:0, r:0, cap:"æœ¬äºº" },
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"å¥½ããªã‚‚ã®" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"å®‰å¿ƒã‚°ãƒƒã‚º" },
    }},
    { id:"p2", title:"ã„ã„ã¨ã“ã‚ãƒ»å¥½ã", fields: {
      strengths:"", interests:"", triggers:"", calming:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"å¾—æ„ãªã“ã¨" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"å¥½ããªå ´æ‰€" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"è½ã¡ç€ã" },
    }},
    { id:"p3", title:"ä¼ãˆæ–¹", fields: {
      understand:"", express:"", supportTips:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"è¦–è¦šæ”¯æ´" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"è¦‹æœ¬" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"ãƒ«ãƒ¼ãƒ«" },
    }},
    { id:"p4", title:"å­¦æ ¡ãƒ»é…æ…®", fields: {
      sensory:"", life:"", learning:"",
      schoolArrival:"", schoolClass:"", schoolRecess:"", schoolDismissal:"",
      panicSigns:"", panicSupport:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"æ•™å®¤" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"é…æ…®" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³" },
    }},
    { id:"p5", title:"å ´é¢åˆ¥", fields: {
      rows:[
        {scene:"äºˆå®šã®å¤‰æ›´", fact:"", support:""},
        {scene:"æŒ‡ç¤ºã®ç†è§£", fact:"", support:""},
        {scene:"éŸ³ã®éæ•", fact:"", support:""},
        {scene:"åˆ‡ã‚Šæ›¿ãˆ", fact:"", support:""},
        {scene:"å‹ã ã¡ã¨ã®ãƒˆãƒ©ãƒ–ãƒ«", fact:"", support:""},
      ],
      teacherMessage:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"é€£çµ¡æ‰‹æ®µ" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"æŒã¡ç‰©" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"é…å¸ƒç‰©" },
    }},
  ]
};

const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
let state = loadState();
let currentPage = 0;

/* =========================
   æç”»
========================= */
function render(){
  const tabsDiv = document.getElementById("tabs");
  tabsDiv.innerHTML = "";
  state.pages.forEach((p, i) => {
    const b = document.createElement("div");
    b.className = `tab ${i===currentPage ? "active" : ""}`;
    b.textContent = `${i+1}) ${p.title}`;
    b.onclick = () => { currentPage = i; render(); };
    tabsDiv.appendChild(b);
  });

  const stage = document.getElementById("stage");
  stage.innerHTML = `<div class="sheet-wrap" id="page-view"></div>`;
  document.getElementById("page-view").appendChild(createPageDOM(currentPage, false));

  persist();
}

function createPageDOM(idx, isExport){
  const p = state.pages[idx];
  const f = p.fields;

  const sheet = document.createElement("div");
  sheet.className = "sheet";

  const inner = document.createElement("div");
  inner.className = "sheet-inner";
  sheet.appendChild(inner);

  const section = (t)=>{
    const h = document.createElement("h2");
    h.className = "secTitle";
    h.textContent = t;
    return h;
  };

  const box = (lbl, val, key, wide=false) => {
    const d = document.createElement("div");
    d.className = `box ${wide ? "wide" : ""}`;
    d.onclick = () => openTextModal(idx, key, lbl);
    const v = (val && String(val).trim().length) ? escapeHtml(val) : (isExport ? "" : `<span class="hint">ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›</span>`);
    d.innerHTML = `<div class="lbl">${escapeHtml(lbl)}</div><div class="val">${v}</div>`;
    return d;
  };

  const photo = (ph, key, size) => {
    const d = document.createElement("div");
    d.className = `photoCard ${size}`;
    d.onclick = () => openPhotoModal(idx, key);

    if(ph?.src){
      const img = document.createElement("img");
      img.src = ph.src;
      img.style.transform = `translate(${ph.x || 0}px, ${ph.y || 0}px) translate(-50%, -50%) rotate(${ph.r || 0}deg) scale(${ph.s || 1})`;
      d.appendChild(img);
    }else{
      const phEl = document.createElement("div");
      phEl.className = "ph";
      phEl.textContent = "ã‚¿ãƒƒãƒ—ã—ã¦\nå†™çœŸé¸æŠ";
      d.appendChild(phEl);
    }
    const cap = document.createElement("div");
    cap.className = "cap";
    cap.textContent = ph?.cap || "å†™çœŸ";
    d.appendChild(cap);
    return d;
  };

  /* p1 */
  if(p.id==="p1"){
    const h = document.createElement("div");
    h.innerHTML = `<div class="h1">ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯</div><div class="note">å­¦æ ¡ãƒ»æ”¯æ´è€…ã®æ–¹ã¸ï¼šæ¥ã—æ–¹ã®ãƒ’ãƒ³ãƒˆ</div>`;
    inner.appendChild(h);

    const m = document.createElement("div");
    m.className = "meta";

    m.appendChild(photo(f.photoMain, "photoMain", "large"));

    const g = document.createElement("div");
    g.className = "infoGrid";
    g.appendChild(box("æ›´æ–°æ—¥", f.updatedDate, "updatedDate"));
    g.appendChild(box("æ°å", f.childName, "childName"));
    g.appendChild(box("æ„›ç§°", f.nickname, "nickname"));
    g.appendChild(box("ç”Ÿå¹´æœˆæ—¥", f.birth, "birth"));
    g.appendChild(box("å¹´é½¢", f.age, "age"));
    g.appendChild(box("è¨ºæ–­ï¼ˆä»»æ„ï¼‰", f.diagnosis, "diagnosis"));
    g.appendChild(box("ã²ã¨ã“ã¨ï¼ˆä»»æ„ï¼‰", f.messageShort, "messageShort", true));
    m.appendChild(g);

    inner.appendChild(m);

    inner.appendChild(section("å†™çœŸï¼ˆå¥½ããªã‚‚ã®ãƒ»å®‰å¿ƒã‚°ãƒƒã‚ºãªã©ï¼‰"));
    const row = document.createElement("div");
    row.className = "meta";
    row.appendChild(photo(f.photo1, "photo1", "small"));
    row.appendChild(photo(f.photo2, "photo2", "small"));
    inner.appendChild(row);
  }

  /* p2 */
  if(p.id==="p2"){
    inner.appendChild(section("ğŸŒŸ ã„ã„ã¨ã“ã‚ãƒ»å¥½ããªã“ã¨"));
    const row = document.createElement("div");
    row.className = "meta";
    row.appendChild(photo(f.photo1, "photo1", "small"));
    row.appendChild(photo(f.photo2, "photo2", "small"));
    row.appendChild(photo(f.photo3, "photo3", "small"));
    inner.appendChild(row);

    inner.appendChild(box("å¼·ã¿", f.strengths, "strengths", true));
    inner.appendChild(box("èˆˆå‘³ãƒ»å¥½ããªã‚‚ã®", f.interests, "interests", true));
    inner.appendChild(box("è‹¦æ‰‹ï¼ˆäº‹å®Ÿï¼‰", f.triggers, "triggers", true));
    inner.appendChild(box("è½ã¡ç€ãæ–¹æ³•ï¼ˆå¯¾ç­–ï¼‰", f.calming, "calming", true));
  }

  /* p3 */
  if(p.id==="p3"){
    inner.appendChild(section("ğŸ“¢ ä¼ãˆæ–¹ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³"));
    const row = document.createElement("div");
    row.className = "meta";
    row.appendChild(photo(f.photo1, "photo1", "small"));
    row.appendChild(photo(f.photo2, "photo2", "small"));
    row.appendChild(photo(f.photo3, "photo3", "small"));
    inner.appendChild(row);

    inner.appendChild(box("ç†è§£ã—ã‚„ã™ã„ä¼ãˆæ–¹", f.understand, "understand", true));
    inner.appendChild(box("æœ¬äººã®ä¼ãˆæ–¹", f.express, "express", true));
    inner.appendChild(box("æ”¯æ´ã®ãƒ’ãƒ³ãƒˆï¼ˆå…·ä½“ï¼‰", f.supportTips, "supportTips", true));
  }

  /* p4 */
  if(p.id==="p4"){
    inner.appendChild(section("ğŸ« å­¦æ ¡ç”Ÿæ´» / é…æ…®ãƒã‚¤ãƒ³ãƒˆ"));
    const row = document.createElement("div");
    row.className = "meta";
    row.appendChild(photo(f.photo1, "photo1", "small"));
    row.appendChild(photo(f.photo2, "photo2", "small"));
    row.appendChild(photo(f.photo3, "photo3", "small"));
    inner.appendChild(row);

    inner.appendChild(box("æ„Ÿè¦šï¼ˆéŸ³ãƒ»å…‰ãªã©ï¼‰", f.sensory, "sensory", true));
    inner.appendChild(box("ç”Ÿæ´»ï¼ˆãƒˆã‚¤ãƒ¬ãƒ»çµ¦é£Ÿãªã©ï¼‰", f.life, "life", true));
    inner.appendChild(box("å­¦ç¿’ï¼ˆä½œæ¥­ãƒ»æ¿æ›¸ãªã©ï¼‰", f.learning, "learning", true));
    inner.appendChild(box("æœã®æº–å‚™ãƒ»ç™»æ ¡", f.schoolArrival, "schoolArrival", true));
    inner.appendChild(box("æˆæ¥­ä¸­", f.schoolClass, "schoolClass", true));
    inner.appendChild(box("ä¼‘ã¿æ™‚é–“ãƒ»é›†å›£å ´é¢", f.schoolRecess, "schoolRecess", true));
    inner.appendChild(box("ä¸‹æ ¡ãƒ»åˆ‡ã‚Šæ›¿ãˆ", f.schoolDismissal, "schoolDismissal", true));
    inner.appendChild(box("äºˆå…†ï¼ˆäº‹å®Ÿï¼‰", f.panicSigns, "panicSigns", true));
    inner.appendChild(box("å¯¾å¿œï¼ˆå¯¾ç­–ï¼‰", f.panicSupport, "panicSupport", true));
  }

  /* p5 */
  if(p.id==="p5"){
    inner.appendChild(section("ğŸ“ å ´é¢åˆ¥ï¼ˆäº‹å®Ÿï¼‹å¯¾ç­–ï¼‰"));

    const t = document.createElement("div");
    t.className = "table";
    t.innerHTML = `
      <div class="trow thead">
        <div class="tcell">å ´é¢</div>
        <div class="tcell">äº‹å®Ÿï¼ˆå›°ã‚Šã”ã¨ï¼‰</div>
        <div class="tcell">å¯¾å¿œï¼ˆãŠé¡˜ã„ï¼‰</div>
      </div>
    `;
    f.rows.forEach((r, ri) => {
      const tr = document.createElement("div");
      tr.className = "trow";
      tr.appendChild(cell(r.scene, idx, `rows.${ri}.scene`, isExport));
      tr.appendChild(cell(r.fact, idx, `rows.${ri}.fact`, isExport));
      tr.appendChild(cell(r.support, idx, `rows.${ri}.support`, isExport));
      t.appendChild(tr);
    });
    inner.appendChild(t);

    // è¡Œè¿½åŠ /å‰Šé™¤ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã¯éè¡¨ç¤ºï¼‰
    if(!isExport){
      const ctl = document.createElement("div");
      ctl.style.display = "flex";
      ctl.style.gap = "8px";
      const add = document.createElement("button");
      add.className = "btn";
      add.textContent = "ï¼‹ è¡Œã‚’è¿½åŠ ";
      add.onclick = ()=>{ f.rows.push({scene:"", fact:"", support:""}); render(); };
      const del = document.createElement("button");
      del.className = "btn";
      del.textContent = "âˆ’ æœ€å¾Œã®è¡Œã‚’å‰Šé™¤";
      del.onclick = ()=>{ if(f.rows.length>1) f.rows.pop(); render(); };
      ctl.appendChild(add); ctl.appendChild(del);
      inner.appendChild(ctl);
    }

    inner.appendChild(section("ğŸ“¸ è£œè¶³å†™çœŸ"));
    const row = document.createElement("div");
    row.className = "meta";
    row.appendChild(photo(f.photo1, "photo1", "small"));
    row.appendChild(photo(f.photo2, "photo2", "small"));
    row.appendChild(photo(f.photo3, "photo3", "small"));
    inner.appendChild(row);

    inner.appendChild(section("âœ‰ï¸ å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"));
    inner.appendChild(box("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", f.teacherMessage, "teacherMessage", true));
  }

  return sheet;

  function cell(v, pIdx, key, isExport){
    const c = document.createElement("div");
    c.className = "tcell";
    c.innerHTML = (v && String(v).trim().length)
      ? escapeHtml(v)
      : (isExport ? "" : `<span class="hint">å…¥åŠ›</span>`);
    c.onclick = ()=> openTextModal(pIdx, key, "ãƒ†ãƒ¼ãƒ–ãƒ«å…¥åŠ›");
    return c;
  }
}

/* =========================
   ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæç¤ºã‚³ãƒ¼ãƒ‰ã®è‰¯ã„æ§‹é€ ï¼šdot-pathå¯¾å¿œï¼‰
========================= */
const modal = document.getElementById("modal");
const mContent = document.getElementById("m-content");
const fileInput = document.getElementById("fileInput");

function openTextModal(pIdx, key, lbl){
  const val = getByPath(state.pages[pIdx].fields, key) ?? "";
  mContent.innerHTML = `
    <h3>${escapeHtml(lbl)}</h3>
    <textarea id="m-ta" placeholder="ã“ã“ã«å…¥åŠ›ï¼ˆç©ºæ¬„OKï¼‰">${escapeHtml(val)}</textarea>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="btn primary" id="m-save" style="flex:1">ä¿å­˜</button>
      <button class="btn" id="m-close" style="flex:1">é–‰ã˜ã‚‹</button>
    </div>
  `;
  document.getElementById("m-save").onclick = ()=>{
    const nv = document.getElementById("m-ta").value;
    setByPath(state.pages[pIdx].fields, key, nv);
    closeModal();
  };
  document.getElementById("m-close").onclick = closeModal;
  modal.classList.add("show");
}
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });

function closeModal(){
  modal.classList.remove("show");
  render();
}

/* =========================
   å†™çœŸç·¨é›†ï¼ˆå›è»¢90åº¦ / ãƒ”ãƒ³ãƒæ‹¡å¤§ç¸®å° / ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼‰
   â€»æç¤ºã‚³ãƒ¼ãƒ‰ã®UIè¦ç´ ï¼‹å…ˆã»ã©ã®â€œãƒ”ãƒ³ãƒâ€ã‚’èåˆ
========================= */
let phCtx = null; // {pIdx, key, ph}
let pinch = null;
let touches = new Map();

function openPhotoModal(pIdx, key){
  const ph = state.pages[pIdx].fields[key];
  phCtx = { pIdx, key, ph };

  mContent.innerHTML = `
    <h3>å†™çœŸç·¨é›†</h3>

    <div class="editor-canvas" id="canvas">
      ${ph.src ? `<img id="e-img" src="${ph.src}" alt="">` : `<div style="color:#cbd5e1; text-align:center; padding-top:110px; font-weight:900;">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div>`}
    </div>

    <div class="controls">
      <button class="btn" id="e-pick">ğŸ“¸ é¸æŠ</button>
      <button class="btn" id="e-rot">ğŸ”„ å›è»¢</button>
      <button class="btn" id="e-del">ğŸ—‘ å‰Šé™¤</button>
      <button class="btn" id="e-done">âœ… å®Œäº†</button>
    </div>

    <div style="margin-top:10px;">
      <input type="text" id="e-cap" value="${escapeHtml(ph.cap || "")}" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼šæ•™å®¤ï¼å®‰å¿ƒã‚°ãƒƒã‚ºãªã©ï¼‰">
      <div class="note" style="margin-top:8px;">æ“ä½œï¼šãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼ãƒ”ãƒ³ãƒã§æ‹¡å¤§ç¸®å°ï¼å›è»¢ã¯90Â°ãšã¤</div>
    </div>
  `;

  modal.classList.add("show");

  document.getElementById("e-pick").onclick = ()=> fileInput.click();
  document.getElementById("e-rot").onclick = ()=>{
    ph.r = ((ph.r || 0) + 90) % 360;
    syncEditor();
  };
  document.getElementById("e-del").onclick = ()=>{
    ph.src = "";
    ph.s = 1; ph.x = 0; ph.y = 0; ph.r = 0;
    syncEditor(true);
  };
  document.getElementById("e-done").onclick = ()=>{
    ph.cap = document.getElementById("e-cap").value;
    closeModal();
  };

  fileInput.onchange = (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      ph.src = ev.target.result;
      ph.s = 1; ph.x = 0; ph.y = 0; ph.r = 0;
      openPhotoModal(pIdx, key); // å†æç”»ï¼ˆæç¤ºã‚³ãƒ¼ãƒ‰æ–¹å¼ï¼‰
    };
    reader.readAsDataURL(f);
    fileInput.value = "";
  };

  attachGestures();
  syncEditor();
}

function syncEditor(forceNoImg){
  const { ph } = phCtx;
  const img = document.getElementById("e-img");
  if(!img) return;
  if(forceNoImg) return;

  img.style.transform = `translate(${ph.x || 0}px, ${ph.y || 0}px) translate(-50%, -50%) rotate(${ph.r || 0}deg) scale(${ph.s || 1})`;
}

function attachGestures(){
  const canvas = document.getElementById("canvas");
  const img = document.getElementById("e-img");
  touches.clear();
  pinch = null;

  // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆpointerã§çµ±ä¸€ï¼‰
  let dragging = false;
  let startX = 0, startY = 0;
  let baseX = 0, baseY = 0;

  canvas.onpointerdown = (e)=>{
    if(!phCtx?.ph?.src || !img) return;
    dragging = true;
    canvas.setPointerCapture(e.pointerId);
    startX = e.clientX;
    startY = e.clientY;
    baseX = phCtx.ph.x || 0;
    baseY = phCtx.ph.y || 0;
  };
  canvas.onpointermove = (e)=>{
    if(!dragging) return;
    phCtx.ph.x = baseX + (e.clientX - startX);
    phCtx.ph.y = baseY + (e.clientY - startY);
    syncEditor();
  };
  canvas.onpointerup = ()=> dragging = false;
  canvas.onpointercancel = ()=> dragging = false;

  // ãƒ”ãƒ³ãƒæ‹¡å¤§ç¸®å°ï¼ˆtouchï¼‰
  canvas.addEventListener("touchstart", (e)=>{
    if(!phCtx?.ph?.src || !img) return;
    for(const t of e.changedTouches) touches.set(t.identifier, {x:t.clientX, y:t.clientY});
    if(touches.size===2){
      const pts = [...touches.values()];
      pinch = { d0: dist(pts[0], pts[1]), s0: phCtx.ph.s || 1 };
    }
  }, {passive:false});

  canvas.addEventListener("touchmove", (e)=>{
    if(!pinch || touches.size!==2) return;
    e.preventDefault();
    for(const t of e.changedTouches) touches.set(t.identifier, {x:t.clientX, y:t.clientY});
    const pts = [...touches.values()];
    const d = dist(pts[0], pts[1]);
    const ns = clamp(pinch.s0 * (d / Math.max(1, pinch.d0)), 0.5, 3.0);
    phCtx.ph.s = ns;
    syncEditor();
  }, {passive:false});

  canvas.addEventListener("touchend", (e)=>{
    for(const t of e.changedTouches) touches.delete(t.identifier);
    if(touches.size<2) pinch = null;
    else if(touches.size===2){
      const pts = [...touches.values()];
      pinch = { d0: dist(pts[0], pts[1]), s0: phCtx.ph.s || 1 };
    }
  });

  canvas.addEventListener("touchcancel", ()=>{
    touches.clear();
    pinch = null;
  });
}

/* =========================
   å°åˆ· / PDFï¼ˆæç¤ºã‚³ãƒ¼ãƒ‰ã®PDFã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ¡ç”¨ï¼‰
========================= */
const prog = document.getElementById("progress");
const pText = document.getElementById("p-text");
const pSub  = document.getElementById("p-sub");
const pBar  = document.getElementById("p-bar");

document.getElementById("btnPrintPdf").onclick = async ()=>{
  // PCã¯å°åˆ·ã€ã‚¹ãƒãƒ›ã¯PDFç”Ÿæˆï¼ˆåŒä¸€ãƒœã‚¿ãƒ³ï¼‰
  if(!isMobile){
    await printAllPages();
  }else{
    await generatePDFAllPages();
  }
};

async function printAllPages(){
  // å°åˆ·ç”¨DOMã‚’æ§‹ç¯‰ï¼ˆå…¨ãƒšãƒ¼ã‚¸ï¼‰
  const ph = document.getElementById("printHost");
  ph.innerHTML = "";
  state.pages.forEach((_, i)=>{
    const wrap = document.createElement("div");
    wrap.className = "sheet-wrap";
    wrap.style.transform = "none";
    wrap.appendChild(createPageDOM(i, true));
    ph.appendChild(wrap.firstChild);
  });
  ph.style.display = "block";

  // afterprintã§æƒé™¤ï¼ˆæ¥ãªã„ç’°å¢ƒã‚‚ã‚ã‚‹ã®ã§ä¿é™ºï¼‰
  const onAfter = ()=>{
    window.removeEventListener("afterprint", onAfter);
    ph.style.display = "none";
    ph.innerHTML = "";
  };
  window.addEventListener("afterprint", onAfter);
  window.print();
  setTimeout(()=>{ try{ onAfter(); }catch(_){} }, 8000);
}

async function generatePDFAllPages(){
  if(!window.html2canvas || !window.jspdf || !window.jspdf.jsPDF){
    alert("PDFç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
    return;
  }

  prog.style.display = "flex";
  pSub.textContent = "ç”»åƒãŒå¤šã„ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™";
  pBar.style.width = "0%";

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  const host = document.getElementById("exportHost");
  host.innerHTML = "";

  // ç«¯æœ«è² è·ã‚’è€ƒæ…®ã—ã¤ã¤é®®æ˜ã•ã‚‚ç¢ºä¿
  const scale = isMobile ? 1.8 : 2.0;

  for(let i=0; i<state.pages.length; i++){
    pText.textContent = `ãƒšãƒ¼ã‚¸ ${i+1} / ${state.pages.length} ã‚’ä½œæˆä¸­...`;
    pBar.style.width = `${Math.round((i / state.pages.length) * 100)}%`;

    const pageDom = createPageDOM(i, true);
    host.appendChild(pageDom);

    // æç”»å¾…æ©Ÿï¼ˆæç¤ºã‚³ãƒ¼ãƒ‰ã®è‰¯ã„ã¨ã“ã‚ï¼šå¾…ã£ã¦ã‹ã‚‰æ’®ã‚‹ï¼‰
    await nextFrame();
    await sleep(220);

    const canvas = await html2canvas(pageDom, {
      scale,
      useCORS: true,
      backgroundColor: "#ffffff",
      logging: false
    });

    const imgData = canvas.toDataURL("image/jpeg", 0.92);
    if(i > 0) pdf.addPage();
    pdf.addImage(imgData, "JPEG", 0, 0, 210, 297, undefined, "FAST");

    // æ¬¡ãƒšãƒ¼ã‚¸ã¸ï¼šDOMã‚’ç©ºã«ã—ã¦ãƒ¡ãƒ¢ãƒªç¯€ç´„
    host.innerHTML = "";
    canvas.width = 1; canvas.height = 1;
    await sleep(60);
  }

  pBar.style.width = "100%";
  pText.textContent = "PDFã‚’æº–å‚™ã—ã¦ã„ã¾ã™...";

  const blob = pdf.output("blob");
  const fileName = `support_book_${new Date().toISOString().slice(0,10)}.pdf`;
  const file = new File([blob], fileName, { type: "application/pdf" });

  // ã‚¹ãƒãƒ›ï¼šå…±æœ‰ï¼ˆä¿å­˜å…ˆé¸æŠãŒå‡ºã‚„ã™ã„ï¼‰
  if(navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
    try{
      await navigator.share({ files:[file], title:"ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯" });
      prog.style.display = "none";
      return;
    }catch(e){
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç­‰ â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚¿ãƒ–ã§é–‹ãï¼ˆä¿å­˜ï¼‰
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(()=>URL.revokeObjectURL(url), 60000);

  prog.style.display = "none";
}

/* =========================
   ä¿å­˜/èª­è¾¼/ãƒªã‚»ãƒƒãƒˆ
========================= */
document.getElementById("btnExport").onclick = exportJSON;
document.getElementById("btnImport").onclick = importJSON;
document.getElementById("btnReset").onclick = ()=>{
  if(confirm("å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
    state = clone(TEMPLATE);
    currentPage = 0;
    render();
  }
};

function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "support_book_data.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
}
function importJSON(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json,application/json";
  input.onchange = async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      const text = await f.text();
      const obj = JSON.parse(text);
      state = normalizeState(obj);
      currentPage = 0;
      render();
      alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    }catch(err){
      alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚");
    }
  };
  input.click();
}

/* =========================
   State / Utility
========================= */
function persist(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      return normalizeState(obj);
    }
  }catch(e){}
  return clone(TEMPLATE);
}
function normalizeState(obj){
  // ä¹±ã‚ŒãŸJSONã§ã‚‚ãƒ†ãƒ³ãƒ—ãƒ¬ã«å¯„ã›ã¦å¾©å…ƒ
  const out = clone(TEMPLATE);
  if(!obj || !Array.isArray(obj.pages)) return out;

  out.pages.forEach(tp=>{
    const sp = obj.pages.find(p=>p.id===tp.id);
    if(!sp || !sp.fields) return;

    Object.keys(tp.fields).forEach(k=>{
      const tv = tp.fields[k];
      const sv = sp.fields[k];

      if(typeof tv === "string"){
        if(typeof sv === "string") tp.fields[k] = sv;
        return;
      }
      if(Array.isArray(tv) && k==="rows"){
        if(Array.isArray(sv)){
          tp.fields.rows = sv.map(r=>({
            scene: (r?.scene ?? r?.s ?? ""),
            fact: (r?.fact ?? r?.f ?? ""),
            support: (r?.support ?? r?.t ?? "")
          }));
        }
        return;
      }
      if(tv && typeof tv === "object"){
        if(sv && typeof sv === "object"){
          tp.fields[k].src = sv.src || sv.dataUrl || "";
          tp.fields[k].s = (sv.s ?? sv.scale ?? 1);
          tp.fields[k].x = (sv.x ?? 0);
          tp.fields[k].y = (sv.y ?? 0);
          tp.fields[k].r = (sv.r ?? sv.rot ?? 0);
          tp.fields[k].cap = (sv.cap ?? sv.caption ?? tp.fields[k].cap ?? "å†™çœŸ");
        }
      }
    });
  });

  return out;
}

function getByPath(obj, path){
  const parts = String(path).split(".");
  let cur = obj;
  for(const p of parts){
    if(cur == null) return undefined;
    cur = cur[p];
  }
  return cur;
}
function setByPath(obj, path, value){
  const parts = String(path).split(".");
  let cur = obj;
  for(let i=0;i<parts.length-1;i++){
    const k = parts[i];
    if(cur[k] == null) cur[k] = {};
    cur = cur[k];
  }
  cur[parts[parts.length-1]] = value;
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function clone(x){ return JSON.parse(JSON.stringify(x)); }

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())); }
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }

/* Init */
render();
</script>
</body>
</html>
