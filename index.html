<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ï¼ˆè‡ªå‹•ãƒšãƒ¼ã‚¸é€ã‚Šå¯¾å¿œç‰ˆï¼‰</title>

<style>
  :root{
    --a4-w: 210mm;
    --a4-h: 297mm;
    --page-padding: 10mm; 
    --content-h: 277mm; /* 297 - 20 */

    --stroke: rgba(15,23,42,0.14);
    --text: #0b1220;
    --muted: rgba(15,23,42,0.64);

    --accent: #2563eb;
    --accent2:#7c3aed;

    --sheet-scale: 0.42;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Segoe UI", sans-serif;
    color:var(--text);
    background:#f1f5f9;
    display:flex;
    flex-direction:column;
    height:100vh;
  }

  header{
    position:sticky; top:0; z-index:50;
    background:#fff;
    border-bottom:1px solid var(--stroke);
    padding:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .hdr-title{ font-weight:900; font-size:14px; line-height:1.2; }
  .hdr-sub{ font-size:11px; color:var(--muted); margin-top:2px; }
  .hdr-right{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }

  .btn{
    border:1px solid var(--stroke); background:#fff; padding:8px 12px; border-radius:10px;
    font-size:13px; font-weight:800; cursor:pointer; user-select:none; transition: transform 0.1s;
  }
  .btn.primary{ background:linear-gradient(135deg,var(--accent), var(--accent2)); color:#fff; border:none; }
  .btn:active{ transform: translateY(1px); }

  main{
    flex:1; overflow-y:auto; padding:0 0 40px 0;
    display:flex; flex-direction:column; align-items:center; gap:20px;
  }

  .tabs-container {
    position: sticky; top: 0; z-index: 40;
    background: rgba(255,255,255,0.95); backdrop-filter: blur(4px);
    width: 100%; border-bottom: 1px solid var(--stroke);
    padding: 10px; display: flex; justify-content: center;
  }
  .tabs{
    display:flex; gap:8px; overflow-x:auto; width:100%; max-width:520px;
    padding:2px; scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar{ display:none; }
  .tab{
    flex:0 0 auto; padding:8px 16px; border-radius:999px;
    border:1px solid #cbd5e1; background:#f8fafc; color: var(--muted);
    font-size:12px; cursor:pointer; font-weight:800; transition: all 0.2s ease; white-space:nowrap;
  }
  .tab.active{
    background:var(--accent); color:#fff; border-color:var(--accent);
    box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); transform: translateY(-1px);
  }

  /* Preview Stage */
  .stage{
    width: min(96vw, 520px);
    display:flex; flex-direction:column; gap:20px; align-items:center;
    margin-top:10px;
  }
  .sheet-wrap{
    transform: scale(var(--sheet-scale)); transform-origin: top center;
    width: var(--a4-w); height: var(--a4-h); /* Fixed container size for scaling */
    margin-bottom: calc(var(--a4-h) * (var(--sheet-scale) - 1) + 20px); /* Adjust margin for scale */
  }
  .sheet{
    width: var(--a4-w); height: var(--a4-h);
    background:#fff; position:relative; overflow:hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.10);
    border:1px solid rgba(2,6,23,0.10); border-radius: 12px;
  }
  /* é‡è¦: sheet-inner ã¯çµ¶å¯¾é…ç½®ã›ãšã€é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã™ã‚‹ãŒã€é«˜ã•åˆ¶é™åˆ¤å®šã«ä½¿ç”¨ */
  .sheet-inner{
    width: 100%; height: 100%;
    padding: var(--page-padding);
    display: flex; flex-direction: column; 
    align-items: stretch;
    /* gapã¯JSå´ã§marginã¨ã—ã¦åˆ¶å¾¡ã—ãŸã»ã†ãŒãƒšãƒ¼ã‚¸é€ã‚Šã®è¨ˆç®—ãŒæ­£ç¢ºã ãŒã€ç°¡æ˜“çš„ã«CSSã§æŒ‡å®š */
    gap: 0; 
  }
  
  /* Block Items (ãƒšãƒ¼ã‚¸é€ã‚Šã®å˜ä½) */
  .p-block {
    margin-bottom: 5mm;
    flex-shrink: 0; /* ç¸®å°ã•ã›ãªã„ */
  }

  /* Components */
  .secTitle{
    font-size:14px; font-weight:1000; margin:0 0 2mm 0;
    border-bottom: 2px solid var(--accent); padding-bottom: 4px;
    display: inline-block;
  }
  .h1{ font-size:22px; font-weight:1000; margin:0; }
  .note{ font-size:11px; color:var(--muted); line-height:1.35; }

  .meta{ display:flex; gap:5mm; align-items:flex-start; margin-bottom:5mm; }

  .photoCard{
    border:1px solid var(--stroke); border-radius:12px; overflow:hidden;
    position:relative; background:#f8fafc; cursor:pointer;
  }
  .photoCard.large{ width: 58mm; height: 74mm; flex:0 0 auto; }
  .photoCard.small{ width: 40mm; height: 30mm; flex:0 0 auto; }
  .photoCard img{
    position:absolute; left:50%; top:50%; width:120%; height:auto;
    transform-origin:center; pointer-events:none; user-select:none;
  }
  .photoCard .ph{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    color:#cbd5e1; font-weight:900; font-size:10px; text-align:center; padding:8px; white-space:pre-line;
  }
  .photoCard .cap{
    position:absolute; bottom:0; width:100%; background:rgba(255,255,255,0.85);
    font-size:10px; padding:3px 6px; text-align:center; font-weight:900; color:#0b1220;
  }

  /* Flex Grid for Flow */
  .flow-grid {
    display: flex; flex-wrap: wrap; gap: 4mm;
  }

  .box{
    border:1px solid var(--stroke); border-radius:10px; padding:8px; background:#fff;
    min-height:16mm; cursor:pointer; transition: background 0.1s;
    width: 100%; /* Default full width */
  }
  /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ï¼ˆãƒšãƒ¼ã‚¸é€ã‚Šå¯¾å¿œã®ãŸã‚Flex ItemåŒ–ï¼‰ */
  .box.half { width: calc(50% - 2mm); }

  .box:active{ background:#f1f5f9; }
  .lbl{ font-size:10px; color:var(--muted); font-weight:900; }
  .val{ font-size:12px; white-space:pre-wrap; margin-top:2px; line-height:1.35; word-break:break-word; }
  .hint{ color:#cbd5e1; font-style:italic; font-weight:700; }

  /* Table */
  .table-wrap { width:100%; border:1px solid var(--stroke); border-radius:10px; overflow:hidden; background:#fff; }
  .trow{ display:grid; grid-template-columns: 25% 37.5% 37.5%; border-top:1px solid var(--stroke); }
  .trow:first-child{ border-top:none; }
  .thead{ background:#f8fafc; font-weight:1000; }
  .tcell{ padding:8px; font-size:11px; min-height:12mm; word-break:break-word; cursor:pointer; line-height:1.35; }

  /* Modal */
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100;
    display:none; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(2px);
  }
  .modal.show{ display:flex; }
  .m-content{
    background:#fff; width:100%; max-width:520px; border-radius:15px; padding:20px;
    max-height:90vh; overflow-y:auto; box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    animation: popIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes popIn{ from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
  .m-content h3{ margin:0 0 14px 0; font-size:16px; font-weight:1000; }
  
  textarea, input[type="text"], input[type="date"]{
    width:100%; padding:12px; border-radius:10px; border:1px solid rgba(15,23,42,0.18);
    font-size:16px; font-family: inherit; outline:none;
  }
  textarea:focus, input:focus{ border-color:var(--accent); }
  textarea{ min-height:140px; resize:vertical; }

  /* Photo editor */
  .editor-canvas{
    width:100%; height:260px; background:#111827; position:relative;
    overflow:hidden; border-radius:12px; touch-action:none; border:1px solid rgba(255,255,255,0.12);
  }
  .editor-canvas img{
    position:absolute; left:50%; top:50%; width:120%; height:auto;
    transform-origin:center; user-select:none; pointer-events:none;
  }
  .controls{ display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin-top:10px; }
  .controls .btn{ padding:10px 8px; font-size:12px; }

  /* Progress overlay */
  #progress{
    position:fixed; inset:0; background:rgba(0,0,0,0.85); color:#fff;
    display:none; flex-direction:column; align-items:center; justify-content:center;
    z-index:200; padding:20px; text-align:center;
  }
  .p-wrap{ width:min(320px, 80vw); height:10px; background:#374151; border-radius:999px; margin-top:14px; overflow:hidden; }
  #p-bar{ width:0%; height:100%; background:var(--accent); transition:0.25s; }

  /* Export Host */
  #exportHost{ position:fixed; top:0; left:0; z-index:-9999; opacity:0; pointer-events:none; }

  /* Print CSS */
  @page { size:A4 portrait; margin:0; }
  @media print{
    header, .tabs-container, #progress, .modal, .btn-row { display:none !important; }
    body, main { background:#fff; height:auto; display:block; padding:0; margin:0; overflow:visible; }
    .stage { width:auto; margin:0; display:block; }
    .sheet-wrap { 
      transform:none !important; width:auto !important; height:auto !important; margin:0 !important; 
      page-break-after: always; break-after: page; 
    }
    .sheet { border:none !important; box-shadow:none !important; page-break-inside: avoid; }
    /* å°åˆ·æ™‚ã¯å…¨ã¦ã®ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º */
    .sheet-wrap { display:block !important; }
  }
</style>
</head>

<body>

<header>
  <div>
    <div class="hdr-title">ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆ</div>
    <div class="hdr-sub">é•·æ–‡å¯¾å¿œãƒ»è‡ªå‹•ãƒšãƒ¼ã‚¸é€ã‚Š</div>
  </div>
  <div class="hdr-right">
    <button class="btn primary" id="btnPrintPdf">å‡ºåŠ›</button>
    <button class="btn" id="btnExport">ä¿å­˜</button>
    <button class="btn" id="btnImport">èª­è¾¼</button>
    <button class="btn" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</header>

<main>
  <div class="tabs-container">
    <div class="tabs" id="tabs"></div>
  </div>
  <div class="stage" id="stage"></div>
</main>

<div id="progress">
  <div id="p-text">PDFä½œæˆä¸­...</div>
  <div id="p-sub"></div>
  <div class="p-wrap"><div id="p-bar"></div></div>
</div>

<div class="modal" id="modal">
  <div class="m-content" id="m-content"></div>
</div>

<div id="exportHost"></div>

<input type="file" id="fileInput" accept="image/*" style="display:none">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* =========================
   åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ãƒ»è¨­å®š
========================= */
const STORAGE_KEY = "support_book_v4_pagination";

// ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ç¶­æŒ
const TEMPLATE = {
  pages: [
    { id:"p1", title:"è¡¨ç´™", fields: {
      updatedDate:"", childName:"", nickname:"", birth:"", age:"", diagnosis:"", messageShort:"",
      photoMain:{ src:"", s:1, x:0, y:0, r:0, cap:"æœ¬äºº" },
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"å¥½ããªã‚‚ã®" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"å®‰å¿ƒã‚°ãƒƒã‚º" },
    }},
    { id:"p2", title:"ã„ã„ã¨ã“ã‚ãƒ»å¥½ã", fields: {
      strengths:"", interests:"", triggers:"", calming:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"å¾—æ„ãªã“ã¨" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"å¥½ããªå ´æ‰€" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"è½ã¡ç€ã" },
    }},
    { id:"p3", title:"ä¼ãˆæ–¹", fields: {
      understand:"", express:"", supportTips:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"è¦–è¦šæ”¯æ´" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"è¦‹æœ¬" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"ãƒ«ãƒ¼ãƒ«" },
    }},
    { id:"p4", title:"å­¦æ ¡ãƒ»é…æ…®", fields: {
      sensory:"", life:"", learning:"",
      schoolArrival:"", schoolClass:"", schoolRecess:"", schoolDismissal:"",
      panicSigns:"", panicSupport:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"æ•™å®¤" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"é…æ…®" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³" },
    }},
    { id:"p5", title:"å ´é¢åˆ¥", fields: {
      rows:[
        {scene:"äºˆå®šã®å¤‰æ›´", fact:"", support:""},
        {scene:"æŒ‡ç¤ºã®ç†è§£", fact:"", support:""},
        {scene:"éŸ³ã®éæ•", fact:"", support:""},
        {scene:"åˆ‡ã‚Šæ›¿ãˆ", fact:"", support:""},
        {scene:"å‹ã ã¡ã¨ã®ãƒˆãƒ©ãƒ–ãƒ«", fact:"", support:""},
      ],
      teacherMessage:"",
      photo1:{ src:"", s:1, x:0, y:0, r:0, cap:"é€£çµ¡æ‰‹æ®µ" },
      photo2:{ src:"", s:1, x:0, y:0, r:0, cap:"æŒã¡ç‰©" },
      photo3:{ src:"", s:1, x:0, y:0, r:0, cap:"é…å¸ƒç‰©" },
    }},
  ]
};

const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
let state = loadState();
let currentPage = 0;

/* =========================
   UIæ§‹ç¯‰ãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
========================= */
function render(){
  const tabsDiv = document.getElementById("tabs");
  tabsDiv.innerHTML = "";
  state.pages.forEach((p, i) => {
    const b = document.createElement("div");
    b.className = `tab ${i===currentPage ? "active" : ""}`;
    b.textContent = `${i+1}. ${p.title}`;
    b.onclick = () => {
      currentPage = i;
      render();
      b.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    };
    tabsDiv.appendChild(b);
  });

  const stage = document.getElementById("stage");
  stage.innerHTML = ""; // Clear stage

  // ç¾åœ¨ã®ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦ç´ ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã®é…åˆ—ï¼‰ã‚’ç”Ÿæˆ
  const contentBlocks = createPageBlocks(currentPage, false);
  
  // ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”¨ç´™ã«æµã—è¾¼ã‚€ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ï¼‰
  const sheets = paginateBlocks(contentBlocks);

  // ã‚¹ãƒ†ãƒ¼ã‚¸ã«è¿½åŠ 
  sheets.forEach(sheet => {
    const wrap = document.createElement("div");
    wrap.className = "sheet-wrap";
    wrap.appendChild(sheet);
    stage.appendChild(wrap);
  });

  persist();
}

/**
 * ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­æ ¸é–¢æ•°
 * ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€A4ã‚µã‚¤ã‚ºã®Sheetã«åã¾ã‚‹ã‚ˆã†ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹
 */
function paginateBlocks(blocks) {
  const sheets = [];
  const MAX_H_PX = 1040; // A4 (approx 1123px) - Padding (approx 40px top + 40px bottom) - Safety Margin

  // æœ€åˆã®ã‚·ãƒ¼ãƒˆä½œæˆ
  let currentSheet = createSheetEl();
  let currentInner = currentSheet.querySelector(".sheet-inner");
  sheets.push(currentSheet);

  // è¨ˆæ¸¬ç”¨ã®éš ã—ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå®Ÿéš›ã®é«˜ã•ã‚’æ¸¬ã‚‹ãŸã‚ï¼‰
  const measureContainer = document.createElement("div");
  measureContainer.style.width = "210mm";
  measureContainer.style.position = "absolute";
  measureContainer.style.visibility = "hidden";
  measureContainer.style.padding = "10mm";
  document.body.appendChild(measureContainer);

  let currentH = 0;

  blocks.forEach(block => {
    // ãƒ–ãƒ­ãƒƒã‚¯ã®é«˜ã•ã‚’è¨ˆæ¸¬
    const clone = block.cloneNode(true);
    measureContainer.innerHTML = "";
    measureContainer.appendChild(clone);
    const h = clone.offsetHeight;

    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã«åã¾ã‚‹ã‹ï¼Ÿ
    if (currentH + h > MAX_H_PX && currentH > 0) {
      // åã¾ã‚‰ãªã„ -> æ–°ã—ã„ãƒšãƒ¼ã‚¸ã¸
      currentSheet = createSheetEl();
      currentInner = currentSheet.querySelector(".sheet-inner");
      sheets.push(currentSheet);
      currentH = 0;
    }

    // è¦ç´ ã‚’è¿½åŠ 
    currentInner.appendChild(block);
    currentH += h;
  });

  document.body.removeChild(measureContainer);
  return sheets;
}

function createSheetEl() {
  const s = document.createElement("div");
  s.className = "sheet";
  s.innerHTML = `<div class="sheet-inner"></div>`;
  return s;
}

/**
 * è«–ç†ãƒšãƒ¼ã‚¸ï¼ˆã‚¿ãƒ–ï¼‰ã”ã¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆDOMè¦ç´ ï¼‰ã®é…åˆ—ã‚’ç”Ÿæˆã™ã‚‹
 */
function createPageBlocks(idx, isExport){
  const p = state.pages[idx];
  const f = p.fields;
  const blocks = [];

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼: ãƒ–ãƒ­ãƒƒã‚¯ãƒ©ãƒƒãƒ‘ãƒ¼ä½œæˆ
  const wrap = (els, className="p-block") => {
    const d = document.createElement("div");
    d.className = className;
    if(Array.isArray(els)) els.forEach(e=>d.appendChild(e));
    else d.appendChild(els);
    return d;
  };

  const section = (t)=>{
    const h = document.createElement("h2");
    h.className = "secTitle"; h.textContent = t;
    return wrap(h);
  };

  const box = (lbl, val, key, half=false) => {
    const d = document.createElement("div");
    d.className = `box ${half ? "half" : ""}`;
    d.onclick = () => openTextModal(idx, key, lbl);
    const v = (val && String(val).trim().length) ? escapeHtml(val) : (isExport ? "" : `<span class="hint">ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›</span>`);
    d.innerHTML = `<div class="lbl">${escapeHtml(lbl)}</div><div class="val">${v}</div>`;
    return d; // boxè‡ªä½“ã‚’è¿”ã™ï¼ˆwrapã¯å‘¼ã³å‡ºã—å…ƒã§è¡Œã†å ´åˆã‚‚ã‚ã‚‹ï¼‰
  };

  const photo = (ph, key, size) => {
    const d = document.createElement("div");
    d.className = `photoCard ${size}`;
    d.onclick = () => openPhotoModal(idx, key);
    if(ph?.src){
      const img = document.createElement("img");
      img.src = ph.src;
      img.style.transform = `translate(${ph.x||0}px, ${ph.y||0}px) translate(-50%, -50%) rotate(${ph.r||0}deg) scale(${ph.s||1})`;
      d.appendChild(img);
    }else{
      const phEl = document.createElement("div");
      phEl.className = "ph"; phEl.textContent = "å†™çœŸ";
      d.appendChild(phEl);
    }
    const cap = document.createElement("div");
    cap.className = "cap"; cap.textContent = ph?.cap || "å†™çœŸ";
    d.appendChild(cap);
    return d;
  };

  // --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ ---

  if(p.id==="p1"){
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    const h = document.createElement("div");
    h.innerHTML = `<div class="h1">ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯</div><div class="note">å­¦æ ¡ãƒ»æ”¯æ´è€…ã®æ–¹ã¸ï¼šæ¥ã—æ–¹ã®ãƒ’ãƒ³ãƒˆ</div>`;
    blocks.push(wrap(h));

    // ãƒ¡ã‚¤ãƒ³å†™çœŸ
    const m = document.createElement("div");
    m.className = "meta";
    m.appendChild(photo(f.photoMain, "photoMain", "large"));
    
    // åŸºæœ¬æƒ…å ±ã¯2ã‚«ãƒ©ãƒ ã§ä¸¦ã¹ã‚‹ãŒã€ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«ã«ã™ã‚‹ãŸã‚Flexã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Œã‚‹
    const g = document.createElement("div");
    g.className = "infoGrid flow-grid"; // flow-gridä½¿ç”¨
    g.style.flex = "1";

    const bUp = box("æ›´æ–°æ—¥", f.updatedDate, "updatedDate", true);
    bUp.onclick = () => openDateModal(idx, "updatedDate", "æ›´æ–°æ—¥");
    g.appendChild(bUp);
    
    g.appendChild(box("æ°å", f.childName, "childName", true));
    g.appendChild(box("æ„›ç§°", f.nickname, "nickname", true));
    
    const bBi = box("ç”Ÿå¹´æœˆæ—¥", f.birth, "birth", true);
    bBi.onclick = () => openDateModal(idx, "birth", "ç”Ÿå¹´æœˆæ—¥");
    g.appendChild(bBi);

    g.appendChild(box("å¹´é½¢", f.age, "age", true));
    g.appendChild(box("è¨ºæ–­ï¼ˆä»»æ„ï¼‰", f.diagnosis, "diagnosis", true));
    g.appendChild(box("ã²ã¨ã“ã¨ï¼ˆä»»æ„ï¼‰", f.messageShort, "messageShort", false)); // å…¨å¹…

    m.appendChild(g);
    blocks.push(wrap(m)); // å†™çœŸ+æƒ…å ±ã®ã‚»ãƒƒãƒˆã‚’1ãƒ–ãƒ­ãƒƒã‚¯ã¨ã™ã‚‹ï¼ˆã“ã“ã¯å¤§ãããªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŒåˆ†å‰²å›°é›£ï¼‰

    // ä¸‹éƒ¨å†™çœŸ
    blocks.push(section("å†™çœŸï¼ˆå¥½ããªã‚‚ã®ãƒ»å®‰å¿ƒã‚°ãƒƒã‚ºãªã©ï¼‰"));
    const row = document.createElement("div");
    row.className = "meta";
    row.appendChild(photo(f.photo1, "photo1", "small"));
    row.appendChild(photo(f.photo2, "photo2", "small"));
    blocks.push(wrap(row));
  }

  else if(p.id==="p5"){
    // å ´é¢åˆ¥ï¼ˆè¡¨ï¼‰
    blocks.push(section("ğŸ“ å ´é¢åˆ¥ï¼ˆäº‹å®Ÿï¼‹å¯¾ç­–ï¼‰"));
    
    // è¡¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç‹¬ç«‹ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    const th = document.createElement("div");
    th.className = "table-wrap";
    th.style.borderBottom = "none";
    th.style.borderRadius = "10px 10px 0 0";
    th.innerHTML = `
      <div class="trow thead">
        <div class="tcell">å ´é¢</div><div class="tcell">äº‹å®Ÿï¼ˆå›°ã‚Šã”ã¨ï¼‰</div><div class="tcell">å¯¾å¿œï¼ˆãŠé¡˜ã„ï¼‰</div>
      </div>
    `;
    blocks.push(wrap(th));

    // å„è¡Œã‚’å€‹åˆ¥ã®ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦ç”Ÿæˆï¼ˆã“ã‚Œã§ãƒšãƒ¼ã‚¸ã¾ãŸããŒå¯èƒ½ã«ï¼‰
    f.rows.forEach((r, ri) => {
      const trWrap = document.createElement("div");
      trWrap.className = "table-wrap";
      trWrap.style.borderRadius = "0"; // è§’ä¸¸ãªã—
      trWrap.style.borderTop = "none"; // ä¸Šç·šãªã—ï¼ˆå‰ã®è¡Œã¨ã¤ãªãŒã‚‹ã‚ˆã†ã«ï¼‰
      // æœ€å¾Œã®è¡Œã ã‘ä¸‹ç·šã¨è§’ä¸¸ã‚’ã¤ã‘ã‚‹å‡¦ç†ã¯é›£ã—ã„ã®ã§ã€å„è¡Œborderã§å›²ã‚€ã‚¹ã‚¿ã‚¤ãƒ«ã«ã™ã‚‹
      
      const tr = document.createElement("div");
      tr.className = "trow";
      tr.style.borderTop = "none"; // table-wrapãŒæ ã‚’æŒã¤ãŸã‚
      tr.appendChild(cell(r.scene, idx, `rows.${ri}.scene`, isExport));
      tr.appendChild(cell(r.fact, idx, `rows.${ri}.fact`, isExport));
      tr.appendChild(cell(r.support, idx, `rows.${ri}.support`, isExport));
      
      trWrap.appendChild(tr);
      blocks.push(wrap(trWrap, "p-block-tight")); // ãƒãƒ¼ã‚¸ãƒ³å°
    });

    if(!isExport){
      const ctl = document.createElement("div");
      ctl.style.display="flex"; ctl.style.gap="8px"; ctl.style.padding="4px 0";
      const add = document.createElement("button"); add.className="btn"; add.textContent="ï¼‹ è¡Œã‚’è¿½åŠ ";
      add.onclick=()=>{ f.rows.push({scene:"",fact:"",support:""}); render(); };
      const del = document.createElement("button"); del.className="btn"; del.textContent="âˆ’ å‰Šé™¤";
      del.onclick=()=>{ if(f.rows.length>1) f.rows.pop(); render(); };
      ctl.appendChild(add); ctl.appendChild(del);
      blocks.push(wrap(ctl));
    }

    blocks.push(section("ğŸ“¸ è£œè¶³å†™çœŸ"));
    const prow = document.createElement("div");
    prow.className = "meta";
    prow.appendChild(photo(f.photo1, "photo1", "small"));
    prow.appendChild(photo(f.photo2, "photo2", "small"));
    prow.appendChild(photo(f.photo3, "photo3", "small"));
    blocks.push(wrap(prow));

    blocks.push(section("âœ‰ï¸ å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"));
    blocks.push(wrap(box("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", f.teacherMessage, "teacherMessage", false)));
  }

  else {
    // p2, p3, p4 (æ±ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ)
    let title = "";
    if(p.id==="p2") title = "ğŸŒŸ ã„ã„ã¨ã“ã‚ãƒ»å¥½ããªã“ã¨";
    if(p.id==="p3") title = "ğŸ“¢ ä¼ãˆæ–¹ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³";
    if(p.id==="p4") title = "ğŸ« å­¦æ ¡ç”Ÿæ´» / é…æ…®ãƒã‚¤ãƒ³ãƒˆ";
    
    blocks.push(section(title));
    
    const row = document.createElement("div");
    row.className = "meta";
    row.appendChild(photo(f.photo1, "photo1", "small"));
    row.appendChild(photo(f.photo2, "photo2", "small"));
    row.appendChild(photo(f.photo3, "photo3", "small"));
    blocks.push(wrap(row));

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‹•çš„ã«è¿½åŠ 
    const addField = (lbl, key) => blocks.push(wrap(box(lbl, f[key], key, false)));

    if(p.id==="p2"){
      addField("å¼·ã¿", "strengths");
      addField("èˆˆå‘³ãƒ»å¥½ããªã‚‚ã®", "interests");
      addField("è‹¦æ‰‹ï¼ˆäº‹å®Ÿï¼‰", "triggers");
      addField("è½ã¡ç€ãæ–¹æ³•ï¼ˆå¯¾ç­–ï¼‰", "calming");
    }
    if(p.id==="p3"){
      addField("ç†è§£ã—ã‚„ã™ã„ä¼ãˆæ–¹", "understand");
      addField("æœ¬äººã®ä¼ãˆæ–¹", "express");
      addField("æ”¯æ´ã®ãƒ’ãƒ³ãƒˆï¼ˆå…·ä½“ï¼‰", "supportTips");
    }
    if(p.id==="p4"){
      addField("æ„Ÿè¦šï¼ˆéŸ³ãƒ»å…‰ãªã©ï¼‰", "sensory");
      addField("ç”Ÿæ´»ï¼ˆãƒˆã‚¤ãƒ¬ãƒ»çµ¦é£Ÿãªã©ï¼‰", "life");
      addField("å­¦ç¿’ï¼ˆä½œæ¥­ãƒ»æ¿æ›¸ãªã©ï¼‰", "learning");
      addField("æœã®æº–å‚™ãƒ»ç™»æ ¡", "schoolArrival");
      addField("æˆæ¥­ä¸­", "schoolClass");
      addField("ä¼‘ã¿æ™‚é–“ãƒ»é›†å›£å ´é¢", "schoolRecess");
      addField("ä¸‹æ ¡ãƒ»åˆ‡ã‚Šæ›¿ãˆ", "schoolDismissal");
      addField("äºˆå…†ï¼ˆäº‹å®Ÿï¼‰", "panicSigns");
      addField("å¯¾å¿œï¼ˆå¯¾ç­–ï¼‰", "panicSupport");
    }
  }

  return blocks;

  function cell(v, pIdx, key, isExport){
    const c = document.createElement("div");
    c.className = "tcell";
    c.innerHTML = (v && String(v).trim().length) ? escapeHtml(v) : (isExport ? "" : `<span class="hint">å…¥åŠ›</span>`);
    c.onclick = ()=> openTextModal(pIdx, key, "ãƒ†ãƒ¼ãƒ–ãƒ«å…¥åŠ›");
    return c;
  }
}

/* =========================
   ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ç·¨é›†æ©Ÿèƒ½
========================= */
const modal = document.getElementById("modal");
const mContent = document.getElementById("m-content");
const fileInput = document.getElementById("fileInput");

function openDateModal(pIdx, key, lbl){
  let val = getByPath(state.pages[pIdx].fields, key) ?? "";
  let isoVal = "";
  const m = val.match(/(\d{4}).(\d{1,2}).(\d{1,2})/);
  if(m) isoVal = `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
  mContent.innerHTML = `
    <h3>${escapeHtml(lbl)}</h3>
    <input type="date" id="m-date" value="${isoVal}" style="font-size:18px; padding:12px;">
    <div style="display:flex; gap:10px; margin-top:20px;">
      <button class="btn primary" id="m-save-date" style="flex:1">æ±ºå®š</button>
      <button class="btn" id="m-close" style="flex:1">é–‰ã˜ã‚‹</button>
    </div>
  `;
  document.getElementById("m-save-date").onclick = ()=>{
    const dVal = document.getElementById("m-date").value;
    if(dVal){
      const [y, m, d] = dVal.split("-");
      setByPath(state.pages[pIdx].fields, key, `${y}å¹´${parseInt(m)}æœˆ${parseInt(d)}æ—¥`);
    } else {
      setByPath(state.pages[pIdx].fields, key, "");
    }
    closeModal();
  };
  document.getElementById("m-close").onclick = closeModal;
  modal.classList.add("show");
}

function openTextModal(pIdx, key, lbl){
  const val = getByPath(state.pages[pIdx].fields, key) ?? "";
  mContent.innerHTML = `
    <h3>${escapeHtml(lbl)}</h3>
    <textarea id="m-ta" placeholder="ã“ã“ã«å…¥åŠ›ï¼ˆç©ºæ¬„OKï¼‰">${escapeHtml(val)}</textarea>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="btn primary" id="m-save" style="flex:1">ä¿å­˜</button>
      <button class="btn" id="m-close" style="flex:1">é–‰ã˜ã‚‹</button>
    </div>
  `;
  document.getElementById("m-save").onclick = ()=>{
    setByPath(state.pages[pIdx].fields, key, document.getElementById("m-ta").value);
    closeModal();
  };
  document.getElementById("m-close").onclick = closeModal;
  modal.classList.add("show");
}
modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });
function closeModal(){ modal.classList.remove("show"); render(); }

/* å†™çœŸç·¨é›† */
let phCtx = null;
function openPhotoModal(pIdx, key){
  const ph = state.pages[pIdx].fields[key];
  phCtx = { pIdx, key, ph };
  mContent.innerHTML = `
    <h3>å†™çœŸç·¨é›†</h3>
    <div class="editor-canvas" id="canvas">
      ${ph.src ? `<img id="e-img" src="${ph.src}" alt="">` : `<div style="color:#cbd5e1; text-align:center; padding-top:110px; font-weight:900;">å†™çœŸãªã—</div>`}
    </div>
    <div class="controls">
      <button class="btn" id="e-pick">ğŸ“¸ é¸æŠ</button>
      <button class="btn" id="e-rot">ğŸ”„ å›è»¢</button>
      <button class="btn" id="e-del">ğŸ—‘ å‰Šé™¤</button>
      <button class="btn" id="e-done">âœ… å®Œäº†</button>
    </div>
    <div style="margin-top:10px;">
      <input type="text" id="e-cap" value="${escapeHtml(ph.cap || "")}" placeholder="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³">
    </div>
  `;
  modal.classList.add("show");
  document.getElementById("e-pick").onclick = ()=> fileInput.click();
  document.getElementById("e-rot").onclick = ()=>{ ph.r = ((ph.r||0)+90)%360; syncEditor(); };
  document.getElementById("e-del").onclick = ()=>{ ph.src=""; ph.s=1; ph.x=0; ph.y=0; ph.r=0; syncEditor(true); };
  document.getElementById("e-done").onclick = ()=>{ ph.cap = document.getElementById("e-cap").value; closeModal(); };
  
  // ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ãƒ”ãƒ³ãƒæ“ä½œã®ãƒã‚¤ãƒ³ãƒ‰
  attachGestures();
  syncEditor();
}
fileInput.onchange = (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    phCtx.ph.src = ev.target.result;
    phCtx.ph.s=1; phCtx.ph.x=0; phCtx.ph.y=0; phCtx.ph.r=0;
    openPhotoModal(phCtx.pIdx, phCtx.key);
  };
  reader.readAsDataURL(f);
  fileInput.value = "";
};
function syncEditor(noImg){
  const img = document.getElementById("e-img");
  if(img && !noImg) img.style.transform = `translate(${phCtx.ph.x||0}px, ${phCtx.ph.y||0}px) translate(-50%, -50%) rotate(${phCtx.ph.r||0}deg) scale(${phCtx.ph.s||1})`;
}
// ç°¡æ˜“çš„ãªã‚¿ãƒƒãƒæ“ä½œï¼ˆå‰å›ã®ã‚³ãƒ¼ãƒ‰ã¨åŒç­‰ï¼‰
let touches = new Map(); let pinch = null;
function attachGestures(){
  const c = document.getElementById("canvas");
  if(!c) return;
  let drag=false, sx=0, sy=0, bx=0, by=0;
  c.onpointerdown = (e)=>{ if(!phCtx?.ph?.src) return; drag=true; c.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; bx=phCtx.ph.x||0; by=phCtx.ph.y||0; };
  c.onpointermove = (e)=>{ if(!drag) return; phCtx.ph.x = bx+(e.clientX-sx); phCtx.ph.y = by+(e.clientY-sy); syncEditor(); };
  c.onpointerup = ()=> drag=false;
}

/* =========================
   å‡ºåŠ›å‡¦ç† (PDF / Print)
   â€»å…¨ãƒšãƒ¼ã‚¸ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ãƒˆã—ã¦ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
========================= */
const prog = document.getElementById("progress");
const pText = document.getElementById("p-text");
const pBar  = document.getElementById("p-bar");

document.getElementById("btnPrintPdf").onclick = async ()=>{
  if(!isMobile) await printAll();
  else await genPDF();
};

async function printAll(){
  const ph = document.getElementById("exportHost");
  ph.innerHTML = "";
  // å…¨ã‚¿ãƒ–ã‚’ãƒ«ãƒ¼ãƒ—ã—ã€ãã‚Œãã‚Œã«ã¤ã„ã¦ã‚·ãƒ¼ãƒˆã‚’ç”Ÿæˆ
  for(let i=0; i<state.pages.length; i++){
    const blocks = createPageBlocks(i, true);
    const sheets = paginateBlocks(blocks);
    sheets.forEach(s => {
      const wrap = document.createElement("div");
      wrap.className = "sheet-wrap";
      wrap.appendChild(s);
      ph.appendChild(wrap);
    });
  }
  
  // å°åˆ·ç”¨CSSãŒ #exportHost å†…ã® .sheet-wrap ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«
  const style = document.createElement("style");
  style.innerHTML = `@media print { #exportHost { display:block !important; position:static !important; opacity:1 !important; z-index:9999 !important; } }`;
  document.head.appendChild(style);

  window.print();
  
  // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  setTimeout(()=>{ ph.innerHTML = ""; document.head.removeChild(style); }, 1000);
}

async function genPDF(){
  if(!window.html2canvas || !window.jspdf){ alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­è¾¼ã‚¨ãƒ©ãƒ¼"); return; }
  prog.style.display = "flex"; pBar.style.width = "0%";
  
  await new Promise(r=>setTimeout(r,100));
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  const host = document.getElementById("exportHost");
  host.innerHTML = "";

  // å…¨ã‚¿ãƒ–ãƒ»å…¨ã‚·ãƒ¼ãƒˆã‚’ãƒªã‚¹ãƒˆåŒ–
  const allSheets = [];
  for(let i=0; i<state.pages.length; i++){
    const blocks = createPageBlocks(i, true);
    const sheets = paginateBlocks(blocks);
    allSheets.push(...sheets);
  }

  try {
    for(let i=0; i<allSheets.length; i++){
      pText.textContent = `ãƒšãƒ¼ã‚¸ ${i+1} / ${allSheets.length} ä½œæˆä¸­...`;
      pBar.style.width = `${Math.round((i/allSheets.length)*100)}%`;
      
      const wrap = document.createElement("div");
      wrap.style.width = "210mm"; wrap.style.height = "297mm"; wrap.style.background="#fff";
      wrap.appendChild(allSheets[i]); // ã‚·ãƒ¼ãƒˆã‚’DOMã«è¿½åŠ 
      host.appendChild(wrap);

      await new Promise(r=>requestAnimationFrame(r));
      
      const canvas = await html2canvas(wrap, { scale: 2, useCORS:true, backgroundColor:"#ffffff" });
      const imgData = canvas.toDataURL("image/jpeg", 0.9);
      if(i>0) pdf.addPage();
      pdf.addImage(imgData, "JPEG", 0, 0, 210, 297);
      
      host.innerHTML = ""; // ãƒ¡ãƒ¢ãƒªç¯€ç´„
    }
  } catch(e){
    console.error(e); alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); prog.style.display="none"; return;
  }

  pText.textContent = "ä¿å­˜ä¸­...";
  const blob = pdf.output("blob");
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `supportbook_${Date.now()}.pdf`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
  prog.style.display="none";
}

/* =========================
   Utils / State
========================= */
document.getElementById("btnExport").onclick = ()=>{
  const b = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="data.json"; a.click();
};
document.getElementById("btnImport").onclick = ()=>{
  const i = document.createElement("input"); i.type="file"; i.accept=".json";
  i.onchange=async(e)=>{
    try{ state = normalizeState(JSON.parse(await e.target.files[0].text())); currentPage=0; render(); }
    catch{ alert("èª­è¾¼å¤±æ•—"); }
  };
  i.click();
};
document.getElementById("btnReset").onclick = ()=>{ if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){ state=clone(TEMPLATE); currentPage=0; render(); } };

function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadState(){ try{ return normalizeState(JSON.parse(localStorage.getItem(STORAGE_KEY))); }catch{ return clone(TEMPLATE); } }
function normalizeState(obj){
  const out = clone(TEMPLATE);
  if(!obj || !Array.isArray(obj.pages)) return out;
  out.pages.forEach(tp=>{
    const sp = obj.pages.find(p=>p.id===tp.id);
    if(sp && sp.fields) Object.keys(tp.fields).forEach(k=> tp.fields[k] = sp.fields[k] ?? tp.fields[k]);
  });
  return out;
}
function clone(o){ return JSON.parse(JSON.stringify(o)); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' })[m]); }
function getByPath(o,p){ return p.split('.').reduce((x,k)=>x&&x[k], o); }
function setByPath(o,p,v){ const k=p.split('.'); const last=k.pop(); const t=k.reduce((x,k)=>x[k], o); if(t) t[last]=v; }

// åˆæœŸåŒ–
render();
</script>
</body>
</html>
