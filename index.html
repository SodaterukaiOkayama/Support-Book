<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆãƒ„ãƒ¼ãƒ«ï¼ˆA4ãƒ»ã‚¹ãƒãƒ›å¯¾å¿œãƒ»è¯ã‚„ã‹ãƒ»ç”»åƒãŸãã•ã‚“ï¼‰</title>

<style>
  :root{
    --a4-w: 210mm;
    --a4-h: 297mm;

    --stroke: rgba(15,23,42,0.14);
    --text: #0b1220;
    --muted: rgba(15,23,42,0.64);

    --accent: #2563eb;
    --accent2:#7c3aed;
    --accent3:#16a34a;
    --accent4:#f59e0b;

    --sheet-scale: 0.42;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Segoe UI", sans-serif;
    color:var(--text);
    background:linear-gradient(180deg,#eef2ff, #f8fafc 40%, #f1f5f9);
  }

  header{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--stroke);
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .hdr-left,.hdr-right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .title{ font-weight:900; font-size:13px; line-height:1.1; }
  .sub{ font-size:11px; color:var(--muted); margin-top:2px; }

  .btn{
    border:1px solid var(--stroke);
    background:#fff;
    padding:9px 10px;
    border-radius:10px;
    font-size:13px;
    line-height:1;
    cursor:pointer;
    user-select:none;
  }
  .btn.primary{
    background:linear-gradient(135deg,var(--accent), var(--accent2));
    color:#fff;
    border-color:transparent;
  }
  .btn:active{ transform: translateY(1px); }
  .btn[disabled]{ opacity:0.6; cursor:not-allowed; }

  main{
    padding:12px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }

  .tabs{
    display:flex;
    gap:6px;
    overflow:auto;
    padding:6px 2px;
    max-width: 100%;
  }
  .tab{
    flex:0 0 auto;
    border:1px solid var(--stroke);
    background:#fff;
    padding:8px 10px;
    border-radius:999px;
    font-size:12px;
    cursor:pointer;
    white-space:nowrap;
  }
  .tab.active{
    border-color:transparent;
    background: rgba(37,99,235,0.12);
    color:#1d4ed8;
    font-weight:900;
  }

  .stage{
    width: min(96vw, 520px);
    display:flex;
    justify-content:center;
  }
  .sheet-wrap{
    transform: scale(var(--sheet-scale));
    transform-origin: top center;
    width: var(--a4-w);
  }
  .sheet{
    width: var(--a4-w);
    height: var(--a4-h);
    background:#fff;
    border:1px solid rgba(2,6,23,0.12);
    border-radius: 14px;
    box-shadow: 0 16px 46px rgba(2,6,23,0.14);
    position:relative;
    overflow:hidden;
  }
  .sheet:before{
    content:"";
    position:absolute; inset:-30mm;
    background:
      radial-gradient(22mm 22mm at 20% 20%, rgba(37,99,235,0.10), transparent 60%),
      radial-gradient(26mm 26mm at 85% 15%, rgba(124,58,237,0.10), transparent 60%),
      radial-gradient(30mm 30mm at 15% 80%, rgba(22,163,74,0.10), transparent 60%),
      radial-gradient(28mm 28mm at 85% 85%, rgba(245,158,11,0.10), transparent 60%);
    pointer-events:none;
  }
  .sheet-inner{
    position:absolute; inset:0;
    padding:10mm;
    display:flex;
    flex-direction:column;
    gap:5mm;
  }

  /* å°åˆ·ç”¨ */
  @page{ size: A4 portrait; margin:0; }
  @media print{
    header, .no-print, .hintbar, .tabs, .stage { display:none !important; }
    #printHost{
      display:block !important;
      position:static !important;
      left:auto !important;
      top:auto !important;
      width:auto !important;
      height:auto !important;
      overflow:visible !important;
      visibility: visible !important;
    }
    html,body{ background:#fff !important; }
    main{ padding:0 !important; }
    .sheet-wrap{ transform:none !important; }
    .sheet{
      border:none !important;
      border-radius:0 !important;
      box-shadow:none !important;
      page-break-after: always;
      break-after: page;
      width: var(--a4-w) !important;
      height: var(--a4-h) !important;
    }
    .sheet:last-child{ page-break-after:auto; break-after:auto; }
    .sheet:before{ display:none !important; }
  }

  .hero{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:6mm;
  }
  .h1{ font-size:22px; font-weight:1000; letter-spacing:0.02em; }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background: rgba(37,99,235,0.10);
    color:#1d4ed8;
    border:1px solid rgba(37,99,235,0.22);
    font-size:11px;
    font-weight:900;
    white-space:nowrap;
  }

  .meta{ display:flex; gap:7mm; align-items:flex-start; }

  .photoCard{
    border:1px solid rgba(2,6,23,0.18);
    border-radius: 14px;
    overflow:hidden;
    position:relative;
    background: repeating-linear-gradient(45deg,#f5f5f5,#f5f5f5 10px,#fff 10px,#fff 20px);
  }
  .photoCard.large{ width: 58mm; height: 74mm; flex:0 0 auto; }
  .photoCard.small{ width: 40mm; height: 30mm; }
  .photoCard .ph{
    position:absolute; inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#9aa3af;
    font-weight:900;
    font-size:11px;
    text-align:center;
    white-space:pre-line;
    padding:8px;
  }
  .photoCard img{
    position:absolute; left:0; top:0;
    transform-origin: center;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;
  }
  .photoCard .cap{
    position:absolute; left:0; right:0; bottom:0;
    padding:6px 8px;
    font-size:11px;
    font-weight:900;
    color:#0b1220;
    background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,0.92) 55%, rgba(255,255,255,0.96));
  }
  .photoCard .cap small{ font-weight:700; color:rgba(15,23,42,0.62); }

  .infoGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:4mm;
    flex:1 1 auto;
  }

  .secTitle{
    margin:0;
    font-size:14px;
    font-weight:1000;
    letter-spacing:0.02em;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .secTitle:after{
    content:"";
    height:1px;
    flex:1;
    background: linear-gradient(90deg, rgba(15,23,42,0.18), rgba(15,23,42,0));
  }

  .box{
    border:1px solid rgba(2,6,23,0.14);
    border-radius: 14px;
    padding:8px 10px;
    background: rgba(255,255,255,0.86);
    box-shadow: 0 10px 24px rgba(2,6,23,0.08);
    position:relative;
    min-height: 18mm;
    cursor:pointer;
  }
  .box.wide{ grid-column: 1 / -1; }
  .lbl{
    font-size:11px;
    color:rgba(15,23,42,0.62);
    font-weight:900;
    margin-bottom:4px;
  }
  .val{
    font-size:12px;
    line-height:1.35;
    white-space:pre-wrap;
    word-break: break-word;
  }

  .twoCol{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:4mm;
  }

  .imgRow{ display:flex; gap:4mm; align-items:center; }
  .imgGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:4mm;
  }

  .note{
    font-size:11px;
    color:rgba(15,23,42,0.62);
    line-height:1.35;
  }

  .table{
    border:1px solid rgba(2,6,23,0.14);
    border-radius: 14px;
    overflow:hidden;
    background: rgba(255,255,255,0.86);
    box-shadow: 0 10px 24px rgba(2,6,23,0.08);
  }
  .trow{
    display:grid;
    grid-template-columns: 25% 37.5% 37.5%;
    border-top:1px solid rgba(2,6,23,0.10);
    min-height: 16mm;
  }
  .trow.thead{
    background: rgba(37,99,235,0.10);
    border-top:none;
    min-height:auto;
  }
  .tcell{
    padding:8px 8px;
    font-size:11px;
    font-weight:900;
    color:rgba(15,23,42,0.78);
  }
  .tcell.btncell{ cursor:pointer; }
  .tcell .hint{ color:rgba(15,23,42,0.42); font-weight:800; }
  .tcell .txt{
    white-space:pre-wrap;
    word-break: break-word;
    font-weight:700;
    color:#0b1220;
    line-height:1.35;
  }

  .modal{
    position:fixed; inset:0;
    display:none;
    align-items:flex-end;
    justify-content:center;
    background: rgba(2,6,23,0.50);
    z-index:100;
  }
  .modal.show{ display:flex; }
  .sheetModal{
    width: min(100vw, 720px);
    background: #fff;
    border-top-left-radius: 18px;
    border-top-right-radius: 18px;
    box-shadow: 0 -18px 50px rgba(2,6,23,0.25);
    padding:12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
  }
  .mhead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }
  .mhead .mtitle{
    font-weight:1000;
    font-size:14px;
  }
  textarea,input[type="text"]{
    width:100%;
    border:1px solid rgba(2,6,23,0.14);
    border-radius: 14px;
    padding:10px;
    font-size:14px;
    font-family: inherit;
    outline:none;
  }
  textarea{ min-height: 140px; resize:vertical; }

  .mbar{
    display:flex;
    gap:8px;
    margin-top:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
  }

  .photoEditor{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .phCanvas{
    width:100%;
    height: 280px;
    border:1px solid rgba(2,6,23,0.14);
    border-radius: 14px;
    background:#f8fafc;
    overflow:hidden;
    position:relative;
    touch-action:none;
  }
  .phCanvas img{
    position:absolute; left:50%; top:50%;
    transform-origin: center;
    user-select:none;
    -webkit-user-drag:none;
    pointer-events:none;
  }
  .phTools{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .range{
    display:flex;
    align-items:center;
    gap:8px;
    flex:1 1 auto;
    min-width: 160px;
  }
  input[type="range"]{ width: 100%; }

  .hintbar{
    width:min(96vw, 520px);
    background: rgba(255,255,255,0.92);
    border:1px solid rgba(2,6,23,0.12);
    border-radius: 14px;
    padding:10px 12px;
    font-size:12px;
    color:rgba(15,23,42,0.72);
    box-shadow: 0 10px 24px rgba(2,6,23,0.08);
  }
  .hintbar b{ color:#0b1220; }

  /* é‡è¦ï¼šå°åˆ·ç”¨DOMã¯ã€Œéè¡¨ç¤ºï¼ˆvisibilityï¼‰ã€ã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå‚åŠ ã•ã›ã‚‹ */
  #printHost{
    position: absolute;
    left: -99999px;
    top: 0;
    width: var(--a4-w);
    height: auto;
    overflow: visible;
    visibility: hidden;
    pointer-events: none;
  }
</style>
</head>

<body>

<header class="no-print">
  <div class="hdr-left">
    <div>
      <div class="title">ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ä½œæˆãƒ„ãƒ¼ãƒ«</div>
      <div class="sub">å°åˆ·ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ŒPDFã«ä¿å­˜ã€ã‚‚é¸ã¹ã¾ã™ï¼ˆå…¨ãƒšãƒ¼ã‚¸ä¸€æ‹¬ï¼‰ã€‚</div>
    </div>
  </div>
  <div class="hdr-right">
    <button class="btn primary" id="btnPrint">å°åˆ· / PDFï¼ˆå…¨ãƒšãƒ¼ã‚¸ï¼‰</button>
    <button class="btn" id="btnExport">ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
    <button class="btn" id="btnImport">ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
    <button class="btn" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</header>

<main>
  <div class="hintbar no-print">
    <div>ä¸Šã®ã‚¿ãƒ–ã§ãƒšãƒ¼ã‚¸åˆ‡æ›¿ã€‚ã‚¿ãƒƒãƒ—ã§å…¥åŠ›ã€‚</div>
    <div>å†™çœŸæ ï¼šã‚¿ãƒƒãƒ— â†’ ç”»åƒé¸æŠ â†’ ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼ãƒ”ãƒ³ãƒã§æ‹¡å¤§ç¸®å°ï¼å›è»¢ã‚‚å¯èƒ½ã€‚</div>
    <div>PDFä¿å­˜ã¯ã€å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€Œä¿å­˜å…ˆï¼šPDFã€ç­‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
  </div>

  <div class="tabs no-print" id="tabs"></div>
  <div class="stage" id="stage"></div>

  <!-- å°åˆ·ç”¨ï¼šå…¨ãƒšãƒ¼ã‚¸ã‚’ã“ã“ã«ä¸¦ã¹ã‚‹ï¼ˆç”»é¢å¤–ã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã•ã›ã‚‹ï¼‰ -->
  <div id="printHost" aria-hidden="true"></div>
</main>

<!-- Editor modal -->
<div class="modal" id="modal">
  <div class="sheetModal">
    <div class="mhead">
      <div class="mtitle" id="modalTitle">å…¥åŠ›</div>
      <button class="btn" id="btnClose">é–‰ã˜ã‚‹</button>
    </div>

    <div id="modalBody"></div>

    <div class="mbar">
      <button class="btn" id="btnInsertExample">ä¾‹æ–‡ã‚’å…¥ã‚Œã‚‹</button>
      <button class="btn primary" id="btnSaveField">ä¿å­˜</button>
    </div>
  </div>
</div>

<input type="file" id="photoFile" accept="image/*" style="display:none" />
<input type="file" id="photoCam" accept="image/*" capture="environment" style="display:none" />

<script>
const STORAGE_KEY = "support_book_v2";

const TEMPLATE = {
  pages: [
    { id:"p1", title:"è¡¨ç´™", fields: {
      updatedDate:"", childName:"", nickname:"", birth:"", age:"", diagnosis:"", messageShort:"",
      photoMain:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å†™çœŸ" },
      photoSub1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å¥½ããªã‚‚ã®" },
      photoSub2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å®‰å¿ƒã‚°ãƒƒã‚º" },
    }},
    { id:"p2", title:"ã„ã„ã¨ã“ã‚ãƒ»å¥½ããªã“ã¨", fields: {
      strengths:"", interests:"", triggers:"", calming:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å¾—æ„" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"å¥½ã" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"è½ã¡ç€ã" },
    }},
    { id:"p3", title:"ä¼ãˆæ–¹ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³", fields: {
      understand:"", express:"", supportTips:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"è¦–è¦šæ”¯æ´" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"è¦‹æœ¬" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"ãƒ«ãƒ¼ãƒ«" },
    }},
    { id:"p4", title:"å­¦æ ¡ç”Ÿæ´» / ãƒ‘ãƒ‹ãƒƒã‚¯æ™‚", fields: {
      sensory:"", life:"", learning:"",
      schoolArrival:"", schoolClass:"", schoolRecess:"", schoolDismissal:"",
      panicSigns:"", panicSupport:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"æ•™å®¤" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"é…æ…®" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³" },
    }},
    { id:"p5", title:"å ´é¢åˆ¥ / å…ˆç”Ÿã¸", fields: {
      rows:[
        {scene:"äºˆå®šã®å¤‰æ›´", fact:"", support:""},
        {scene:"æŒ‡ç¤ºã®ç†è§£", fact:"", support:""},
        {scene:"éŸ³ã®éæ•", fact:"", support:""},
        {scene:"æ´»å‹•ã®åˆ‡ã‚Šæ›¿ãˆ", fact:"", support:""},
        {scene:"ãŠå‹é”ã¨ã®ãƒˆãƒ©ãƒ–ãƒ«", fact:"", support:""},
      ],
      teacherMessage:"",
      photo1:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"é€£çµ¡æ‰‹æ®µ" },
      photo2:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"æŒã¡ç‰©" },
      photo3:{ dataUrl:"", scale:1, x:0, y:0, rot:0, caption:"é…å¸ƒç‰©" },
    }},
  ]
};

function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
let state = loadState();

const EXAMPLES = {
  p1:{ messageShort:"åˆã‚ã¦ã®ç’°å¢ƒã§ä¸å®‰ã‚‚å¤§ãã„ã§ã™ãŒã€å…ˆç”Ÿã¨ä¸€ç·’ã«è¦‹å®ˆã£ã¦ã„ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚ä½•ã‹ã‚ã‚Œã°ã„ã¤ã§ã‚‚é€£çµ¡å¸³ã§æ•™ãˆã¦ãã ã•ã„ã€‚" },
  p2:{
    strengths:"ï¼ˆä¾‹ï¼‰ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ï¼é›†ä¸­åŠ›ãŒã‚ã‚‹ï¼æŒ¨æ‹¶ãŒå…ƒæ°—",
    interests:"ï¼ˆä¾‹ï¼‰é›»è»Šï¼å›³é‘‘ï¼æŠ˜ã‚Šç´™ï¼ç‰¹å®šã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼",
    triggers:"ï¼ˆä¾‹ï¼‰å¤§ããªéŸ³ã€æ€¥ãªå¤‰æ›´ã€å¾…ã¤ã“ã¨ ãªã©",
    calming:"ï¼ˆä¾‹ï¼‰é™ã‹ãªå ´æ‰€ã€ã‚¤ãƒ¤ãƒ¼ãƒãƒ•ã€å¥½ããªå°ç‰©ã€ã‚¿ã‚¤ãƒãƒ¼ ãªã©"
  },
  p3:{
    understand:"ï¼ˆä¾‹ï¼‰çŸ­ã„è¨€è‘‰ï¼‹æŒ‡å·®ã—ã§ç†è§£ã—ã‚„ã™ã„ã€‚è¦–è¦šã®ãƒ’ãƒ³ãƒˆãŒã‚ã‚‹ã¨ç¢ºå®Ÿã§ã™ã€‚",
    express:"ï¼ˆä¾‹ï¼‰å›°ã£ã¦ã„ã¦ã‚‚è¨€è‘‰ã«ã—ã«ãã„ã€‚äºŒæŠã§èãã¨ç­”ãˆã‚„ã™ã„ã§ã™ã€‚",
    supportTips:"ï¼ˆä¾‹ï¼‰æŒ‡ç¤ºã®å¾Œã«å€‹åˆ¥ã«æ³¨æ„ã‚’å‘ã‘ã€çŸ­ã„è¨€è‘‰ã§ä¼ãˆã‚‹ã¨å‹•ã‘ã¾ã™ã€‚"
  },
  p4:{
    sensory:"ï¼ˆä¾‹ï¼‰ãƒãƒ£ã‚¤ãƒ ãŒè‹¦æ‰‹ã€‚äº‹å‰äºˆå‘ŠãŒã‚ã‚‹ã¨å®‰å¿ƒã—ã¾ã™ã€‚",
    life:"ï¼ˆä¾‹ï¼‰åé£Ÿã‚ã‚Šã€‚å®Œé£Ÿã‚ˆã‚Šå®‰å¿ƒã—ã¦é£Ÿã¹ã‚‹ã“ã¨ã‚’å„ªå…ˆã—ãŸã„ã§ã™ã€‚",
    learning:"ï¼ˆä¾‹ï¼‰æ‰‹å…ˆãŒä¸å™¨ç”¨ã€‚é“å…·ã®æ‰±ã„ã«è£œåŠ©ãŒå¿…è¦ã§ã™ã€‚",
    schoolArrival:"ï¼ˆä¾‹ï¼‰æœã®æ”¯åº¦ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è¦‹é€šã—ï¼ˆæ¬¡ã¯ä½•ã‚’ã™ã‚‹ã‹ï¼‰ãŒã‚ã‚‹ã¨å‹•ãã‚„ã™ã„ã§ã™ã€‚",
    schoolClass:"ï¼ˆä¾‹ï¼‰ä¸€æ–‰æŒ‡ç¤ºã ã‘ã ã¨è‡ªåˆ†ãŒä½•ã‚’ã™ã¹ãã‹åˆ†ã‹ã‚‰ãªã„æ™‚ãŒã‚ã‚Šã¾ã™ã€‚å€‹åˆ¥ã«çŸ­ã„è¨€è‘‰ã§ç¢ºèªã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚",
    schoolRecess:"ï¼ˆä¾‹ï¼‰è·é›¢æ„ŸãŒè¿‘ããªã‚Šã‚„ã™ã„ã§ã™ã€‚ãƒˆãƒ©ãƒ–ãƒ«ã«ãªã‚Šãã†ãªæ™‚ã¯æ—©ã‚ã«é–“ã«å…¥ã£ã¦ä»£å¼ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨è½ã¡ç€ãã¾ã™ã€‚",
    schoolDismissal:"ï¼ˆä¾‹ï¼‰åˆ‡ã‚Šæ›¿ãˆãŒè‹¦æ‰‹ã§ã™ã€‚ã€Œã‚ã¨ã€‡åˆ†ã€ãªã©æ™‚é–“ã®è¦‹é€šã—ã‚„ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚‹ã¨ç§»è¡Œã—ã‚„ã™ã„ã§ã™ã€‚",
    panicSigns:"ï¼ˆä¾‹ï¼‰é¡”ãŒèµ¤ã„ï¼ç‹¬ã‚Šè¨€ãŒå¢—ãˆã‚‹ï¼å›ºã¾ã‚‹",
    panicSupport:"ï¼ˆä¾‹ï¼‰è½ã¡ç€ãã¾ã§ã¯åˆºæ¿€ã‚’æ¸›ã‚‰ã—ã€çŸ­ã„è¨€è‘‰ã§æ¬¡ã®è¦‹é€šã—ã‚’ä¼ãˆã‚‹ã€‚"
  },
  p5:{
    teacherMessage:"æœ¬äººãŒå­¦æ ¡ã‚’å®‰å¿ƒã§ãã‚‹å ´æ‰€ã¨æ„Ÿã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã€ã‚µãƒãƒ¼ãƒˆã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚ä½•ã‹ã‚ã‚Œã°é€£çµ¡å¸³ç­‰ã§æ•™ãˆã¦ãã ã•ã„ã€‚ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"
  }
};

const stage = document.getElementById("stage");
const tabs = document.getElementById("tabs");
let currentPage = 0;

function buildTabs(){
  tabs.innerHTML = "";
  state.pages.forEach((p, idx)=>{
    const b = document.createElement("button");
    b.className = "tab" + (idx===currentPage ? " active" : "");
    b.textContent = (idx+1) + "ï¼‰" + p.title;
    b.onclick = ()=>{ currentPage = idx; render(); };
    tabs.appendChild(b);
  });
}

function render(){
  buildTabs();
  stage.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "sheet-wrap";
  wrap.appendChild(renderPage(currentPage));
  stage.appendChild(wrap);
  [...tabs.children].forEach((el,i)=> el.classList.toggle("active", i===currentPage));
  persist();
}

/* ======== å°åˆ·ï¼ˆAndroid Chromeå¯¾ç­–ï¼šåŒæœŸã§ç”Ÿæˆâ†’å³printï¼‰ ======== */
let printing = false;
let cleanupTimer = null;

function buildPrintHostSync(){
  const host = document.getElementById("printHost");
  host.innerHTML = "";
  state.pages.forEach((p, idx)=>{
    const sheet = renderPage(idx);
    sheet.style.width = "210mm";
    sheet.style.height = "297mm";
    host.appendChild(sheet);
  });
}

function clearPrintHost(){
  const host = document.getElementById("printHost");
  host.innerHTML = "";
}

function startPrintAllPagesSync(){
  if(printing) return;
  printing = true;

  const btn = document.getElementById("btnPrint");
  const oldText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "å°åˆ·ä¸­â€¦";

  // é‡è¦ï¼šã“ã“ã§await/timeoutã‚’æŒŸã¾ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ç›´å¾Œã«printã™ã‚‹ï¼‰
  try{
    buildPrintHostSync();
    window.print();
  }catch(e){
    console.error(e);
    alert("å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    printing = false;
    btn.disabled = false;
    btn.textContent = oldText;
    clearPrintHost();
    return;
  }

  // afterprintãŒæ¥ã‚‹ãªã‚‰æœ€å„ªå…ˆã§æƒé™¤
  const onAfterPrint = ()=>{
    window.removeEventListener("afterprint", onAfterPrint);
    if(cleanupTimer){ clearTimeout(cleanupTimer); cleanupTimer = null; }
    clearPrintHost();
    printing = false;
    btn.disabled = false;
    btn.textContent = oldText;
  };
  window.addEventListener("afterprint", onAfterPrint);

  // Android Chromeã§afterprintãŒé£›ã°ãªã„å ´åˆã®ä¿é™ºï¼ˆ15ç§’å¾Œã«æƒé™¤ï¼‰
  cleanupTimer = setTimeout(()=>{
    try{ window.removeEventListener("afterprint", onAfterPrint); }catch(_){}
    clearPrintHost();
    printing = false;
    btn.disabled = false;
    btn.textContent = oldText;
  }, 15000);
}

/* ======== Page renderer ======== */
function renderPage(idx){
  const page = state.pages[idx];
  const s = document.createElement("div");
  s.className = "sheet";

  const inner = document.createElement("div");
  inner.className = "sheet-inner";

  if(page.id==="p1"){
    const hero = el("div","hero","");
    const left = el("div","","");
    left.appendChild(el("div","h1","ã‚µãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯"));
    left.appendChild(el("div","note","å­¦æ ¡ãƒ»æ”¯æ´è€…ã®æ–¹ã¸ã€Œã“ã®å­ã®å®‰å¿ƒã®å–ã‚Šæ‰±ã„èª¬æ˜æ›¸ã€"));
    hero.appendChild(left);
    hero.appendChild(el("div","badge","ğŸ“„ A4 / 5ãƒšãƒ¼ã‚¸"));
    inner.appendChild(hero);

    const meta = el("div","meta","");
    const mainPhoto = renderPhotoCard(page.fields.photoMain, "large");
    mainPhoto.onclick = ()=> openPhotoEditor("p1","photoMain");
    meta.appendChild(mainPhoto);

    const grid = el("div","infoGrid","");
    grid.appendChild(renderBox("æ›´æ–°æ—¥", valOrHint(page.fields.updatedDate,"ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›"), ()=>editField("p1","updatedDate")));
    grid.appendChild(renderBox("æ°å", valOrHint(page.fields.childName,"ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›"), ()=>editField("p1","childName")));
    grid.appendChild(renderBox("æ„›ç§°", valOrHint(page.fields.nickname,"ä¾‹ï¼šã€‡ã€‡"), ()=>editField("p1","nickname")));
    grid.appendChild(renderBox("ç”Ÿå¹´æœˆæ—¥ / å¹´é½¢", valOrHint(combineBirthAge(page.fields.birth,page.fields.age),"ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›"), ()=>editBirthAge()));
    grid.appendChild(renderBox("è¨ºæ–­åï¼ˆä»»æ„ï¼‰", valOrHint(page.fields.diagnosis,"ä»»æ„"), ()=>editField("p1","diagnosis")));
    grid.appendChild(renderBox("ä¸€è¨€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰", valOrHint(page.fields.messageShort,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p1","messageShort"), {wide:true}));
    meta.appendChild(grid);

    inner.appendChild(meta);

    inner.appendChild(sectionTitle("ğŸ“¸ å†™çœŸï¼ˆå¥½ããªã‚‚ã®ãƒ»å®‰å¿ƒã‚°ãƒƒã‚ºãªã©ï¼‰"));
    const row = el("div","imgRow","");
    const s1 = renderPhotoCard(page.fields.photoSub1,"small");
    s1.onclick = ()=> openPhotoEditor("p1","photoSub1");
    const s2 = renderPhotoCard(page.fields.photoSub2,"small");
    s2.onclick = ()=> openPhotoEditor("p1","photoSub2");
    row.appendChild(s1); row.appendChild(s2);
    row.appendChild(el("div","note","å†™çœŸæ ã¯ä»Šå¾Œã•ã‚‰ã«å¢—ã‚„ã›ã¾ã™ã€‚"));
    inner.appendChild(row);
  }

  if(page.id==="p2"){
    inner.appendChild(sectionTitle("ğŸŒŸ ã„ã„ã¨ã“ã‚ãƒ»å¥½ããªã“ã¨"));
    const img = el("div","imgGrid","");
    const a = renderPhotoCard(page.fields.photo1,"small"); a.onclick=()=>openPhotoEditor("p2","photo1");
    const b = renderPhotoCard(page.fields.photo2,"small"); b.onclick=()=>openPhotoEditor("p2","photo2");
    const c = renderPhotoCard(page.fields.photo3,"small"); c.onclick=()=>openPhotoEditor("p2","photo3");
    img.appendChild(a); img.appendChild(b); img.appendChild(c);
    inner.appendChild(img);

    inner.appendChild(renderBox("å¼·ã¿", valOrHint(page.fields.strengths,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p2","strengths"), {wide:true}));
    inner.appendChild(renderBox("èˆˆå‘³ãƒ»å¥½ããªã‚‚ã®", valOrHint(page.fields.interests,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p2","interests"), {wide:true}));

    inner.appendChild(sectionTitle("ğŸ§© è‹¦æ‰‹ / è½ã¡ç€ã‘ã‚‹ãƒ’ãƒ³ãƒˆ"));
    const tc = el("div","twoCol","");
    tc.appendChild(renderBox("è‹¦æ‰‹ï¼ˆäº‹å®Ÿï¼‰", valOrHint(page.fields.triggers,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p2","triggers")));
    tc.appendChild(renderBox("è½ã¡ç€ãæ–¹æ³•ï¼ˆå¯¾ç­–ï¼‰", valOrHint(page.fields.calming,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p2","calming")));
    inner.appendChild(tc);
  }

  if(page.id==="p3"){
    inner.appendChild(sectionTitle("ğŸ“¢ ä¼ãˆæ–¹ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³"));
    const img = el("div","imgGrid","");
    const a = renderPhotoCard(page.fields.photo1,"small"); a.onclick=()=>openPhotoEditor("p3","photo1");
    const b = renderPhotoCard(page.fields.photo2,"small"); b.onclick=()=>openPhotoEditor("p3","photo2");
    const c = renderPhotoCard(page.fields.photo3,"small"); c.onclick=()=>openPhotoEditor("p3","photo3");
    img.appendChild(a); img.appendChild(b); img.appendChild(c);
    inner.appendChild(img);

    inner.appendChild(renderBox("ç†è§£ã—ã‚„ã™ã„ä¼ãˆæ–¹", valOrHint(page.fields.understand,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p3","understand"), {wide:true}));
    inner.appendChild(renderBox("æœ¬äººã®ä¼ãˆæ–¹", valOrHint(page.fields.express,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p3","express"), {wide:true}));
    inner.appendChild(renderBox("æ”¯æ´ã®ãƒ’ãƒ³ãƒˆï¼ˆäº‹å®Ÿï¼‹å¯¾ç­–ï¼‰", valOrHint(page.fields.supportTips,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p3","supportTips"), {wide:true}));
  }

  if(page.id==="p4"){
    inner.appendChild(sectionTitle("ğŸ« å­¦æ ¡ç”Ÿæ´» / é…æ…®ãƒã‚¤ãƒ³ãƒˆ"));
    const img = el("div","imgGrid","");
    const a = renderPhotoCard(page.fields.photo1,"small"); a.onclick=()=>openPhotoEditor("p4","photo1");
    const b = renderPhotoCard(page.fields.photo2,"small"); b.onclick=()=>openPhotoEditor("p4","photo2");
    const c = renderPhotoCard(page.fields.photo3,"small"); c.onclick=()=>openPhotoEditor("p4","photo3");
    img.appendChild(a); img.appendChild(b); img.appendChild(c);
    inner.appendChild(img);

    const g = el("div","twoCol","");
    g.appendChild(renderBox("æ„Ÿè¦šï¼ˆéŸ³ãƒ»å…‰ãªã©ï¼‰", valOrHint(page.fields.sensory,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","sensory")));
    g.appendChild(renderBox("ç”Ÿæ´»ï¼ˆãƒˆã‚¤ãƒ¬ãƒ»çµ¦é£Ÿãªã©ï¼‰", valOrHint(page.fields.life,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","life")));
    g.appendChild(renderBox("å­¦ç¿’ï¼ˆæ¿æ›¸ãƒ»ä½œæ¥­ãªã©ï¼‰", valOrHint(page.fields.learning,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","learning"), {wide:true}));
    inner.appendChild(g);

    inner.appendChild(sectionTitle("ğŸ« å­¦æ ¡ç”Ÿæ´»ã§ã®ãƒã‚¤ãƒ³ãƒˆï¼ˆå ´é¢åˆ¥ï¼‰"));
    const sp = el("div","twoCol","");
    sp.appendChild(renderBox("æœã®æº–å‚™ãƒ»ç™»æ ¡", valOrHint(page.fields.schoolArrival,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","schoolArrival")));
    sp.appendChild(renderBox("æˆæ¥­ä¸­ï¼ˆæŒ‡ç¤ºãƒ»æ¿æ›¸ãªã©ï¼‰", valOrHint(page.fields.schoolClass,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","schoolClass")));
    sp.appendChild(renderBox("ä¼‘ã¿æ™‚é–“ãƒ»é›†å›£å ´é¢", valOrHint(page.fields.schoolRecess,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","schoolRecess")));
    sp.appendChild(renderBox("ä¸‹æ ¡ãƒ»åˆ‡ã‚Šæ›¿ãˆ", valOrHint(page.fields.schoolDismissal,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","schoolDismissal")));
    inner.appendChild(sp);

    inner.appendChild(sectionTitle("âš ï¸ ä¸å®‰ãŒå¼·ã„æ™‚ãƒ»ãƒ‘ãƒ‹ãƒƒã‚¯æ™‚"));
    inner.appendChild(renderBox("äºˆå…†ï¼ˆäº‹å®Ÿï¼‰", valOrHint(page.fields.panicSigns,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","panicSigns"), {wide:true}));
    inner.appendChild(renderBox("å¯¾å¿œï¼ˆå¯¾ç­–ï¼‰", valOrHint(page.fields.panicSupport,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p4","panicSupport"), {wide:true}));
  }

  if(page.id==="p5"){
    inner.appendChild(sectionTitle("ğŸ“ å ´é¢åˆ¥ï¼ˆäº‹å®Ÿï¼‹å¯¾ç­–ï¼‰"));
    inner.appendChild(renderScenarioTable(page.fields.rows));
    inner.appendChild(el("div","note","å¿…è¦ãªã‚‰è¡Œæ•°ã‚’å¢—ã‚„ã›ã¾ã™ã€‚"));

    inner.appendChild(sectionTitle("ğŸ“¸ è£œè¶³å†™çœŸï¼ˆæŒã¡ç‰©ãƒ»é€£çµ¡æ–¹æ³•ãªã©ï¼‰"));
    const img = el("div","imgGrid","");
    const a = renderPhotoCard(page.fields.photo1,"small"); a.onclick=()=>openPhotoEditor("p5","photo1");
    const b = renderPhotoCard(page.fields.photo2,"small"); b.onclick=()=>openPhotoEditor("p5","photo2");
    const c = renderPhotoCard(page.fields.photo3,"small"); c.onclick=()=>openPhotoEditor("p5","photo3");
    img.appendChild(a); img.appendChild(b); img.appendChild(c);
    inner.appendChild(img);

    inner.appendChild(sectionTitle("âœ‰ï¸ å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"));
    inner.appendChild(renderBox("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", valOrHint(page.fields.teacherMessage,"ä¾‹æ–‡ã‚ã‚Š"), ()=>editField("p5","teacherMessage"), {wide:true}));
  }

  s.appendChild(inner);
  return s;
}

function sectionTitle(text){
  const h = document.createElement("h2");
  h.className = "secTitle";
  h.textContent = text;
  return h;
}
function renderBox(label, value, onTap, opts={}){
  const b = document.createElement("div");
  b.className = "box" + (opts.wide ? " wide" : "");
  b.setAttribute("role","button");
  b.tabIndex = 0;
  b.onclick = (e)=>{ e.stopPropagation(); onTap?.(); };
  b.onkeydown = (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); onTap?.(); } };
  b.appendChild(el("div","lbl", label));
  b.appendChild(el("div","val", value));
  return b;
}

function renderScenarioTable(rows){
  const t = document.createElement("div");
  t.className = "table";

  const head = document.createElement("div");
  head.className = "trow thead";
  head.appendChild(el("div","tcell","å ´é¢"));
  head.appendChild(el("div","tcell","äº‹å®Ÿï¼ˆå›°ã‚Šã”ã¨ï¼‰"));
  head.appendChild(el("div","tcell","å¯¾ç­–ï¼ˆå…·ä½“çš„ãŠé¡˜ã„ï¼‰"));
  t.appendChild(head);

  rows.forEach((r, i)=>{
    const tr = document.createElement("div");
    tr.className = "trow";
    tr.appendChild(cellBtn(r.scene || "ã‚¿ãƒƒãƒ—", ()=>editTableRow(i), !r.scene));
    tr.appendChild(cellBtn(r.fact || "ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›", ()=>editTableRow(i), !r.fact));
    tr.appendChild(cellBtn(r.support || "ã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ›", ()=>editTableRow(i), !r.support));
    t.appendChild(tr);
  });

  const add = document.createElement("div");
  add.className = "no-print";
  add.style.padding = "8px 0 0 0";

  const btn = document.createElement("button");
  btn.className = "btn";
  btn.textContent = "ï¼‹ è¡Œã‚’è¿½åŠ ";
  btn.onclick = (e)=>{
    e.stopPropagation();
    state.pages.find(p=>p.id==="p5").fields.rows.push({scene:"", fact:"", support:""});
    render();
  };
  add.appendChild(btn);

  const btn2 = document.createElement("button");
  btn2.className = "btn";
  btn2.style.marginLeft = "8px";
  btn2.textContent = "âˆ’ æœ€å¾Œã®è¡Œã‚’å‰Šé™¤";
  btn2.onclick = (e)=>{
    e.stopPropagation();
    const arr = state.pages.find(p=>p.id==="p5").fields.rows;
    if(arr.length>1) arr.pop();
    render();
  };
  add.appendChild(btn2);

  t.appendChild(add);
  return t;
}
function cellBtn(text, onTap, isHint){
  const c = document.createElement("div");
  c.className = "tcell btncell";
  c.onclick = (e)=>{ e.stopPropagation(); onTap?.(); };
  c.onkeydown = (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); onTap?.(); } };
  c.tabIndex = 0;

  const span = document.createElement("div");
  span.className = isHint ? "hint" : "txt";
  span.textContent = text;
  c.appendChild(span);
  return c;
}

function el(tag, cls, text){
  const d = document.createElement(tag);
  if(cls) d.className = cls;
  if(text!==undefined) d.textContent = text;
  return d;
}

/* Photo */
function renderPhotoCard(photo, size="small"){
  const c = document.createElement("div");
  c.className = "photoCard " + size;
  c.title = "ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’è¨­å®š";

  const ph = document.createElement("div");
  ph.className = "ph";
  ph.textContent = "ã‚¿ãƒƒãƒ—ã—ã¦\nå†™çœŸ";
  c.appendChild(ph);

  if(photo?.dataUrl){
    ph.style.display = "none";
    const img = document.createElement("img");
    img.src = photo.dataUrl;
    const rot = photo.rot || 0;
    const scale = photo.scale || 1;
    const x = photo.x || 0;
    const y = photo.y || 0;
    img.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%) rotate(${rot}deg) scale(${scale})`;
    img.style.left = "50%";
    img.style.top = "50%";
    img.style.width = "120%";
    img.style.height = "auto";
    c.appendChild(img);
  }

  const cap = document.createElement("div");
  cap.className = "cap";
  cap.innerHTML = `<div>${escapeHtml(photo?.caption || "å†™çœŸ")}</div><small>ã‚¿ãƒƒãƒ—ã§ç·¨é›†</small>`;
  c.appendChild(cap);

  return c;
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/* Modal editor */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const btnClose = document.getElementById("btnClose");
const btnSaveField = document.getElementById("btnSaveField");
const btnInsertExample = document.getElementById("btnInsertExample");

btnClose.onclick = ()=> closeModal();
modal.onclick = (e)=>{ if(e.target===modal) closeModal(); };

function closeModal(){
  modal.classList.remove("show");
  modalBody.innerHTML = "";
}

function editField(pageId, key){
  const page = state.pages.find(p=>p.id===pageId);
  const value = page.fields[key] ?? "";

  modalTitle.textContent = "å…¥åŠ›ï¼š" + labelFor(pageId, key);
  modalBody.innerHTML = "";
  const ta = document.createElement("textarea");
  ta.value = value;
  ta.placeholder = "ã“ã“ã«å…¥åŠ›ï¼ˆç©ºæ¬„OKï¼‰";
  modalBody.appendChild(ta);

  btnInsertExample.style.display = "inline-flex";
  btnInsertExample.onclick = ()=>{
    const ex = EXAMPLES[pageId]?.[key];
    if(ex!==undefined) ta.value = ex;
    else alert("ã“ã®é …ç›®ã®ä¾‹æ–‡ã¯æœªè¨­å®šã§ã™ã€‚");
  };

  btnSaveField.onclick = ()=>{
    setField(pageId, key, ta.value);
    closeModal();
    render();
  };

  modal.classList.add("show");
  setTimeout(()=>ta.focus(), 50);
}

function labelFor(pageId, key){
  const map = {
    p1:{ updatedDate:"æ›´æ–°æ—¥", childName:"æ°å", nickname:"æ„›ç§°", birth:"ç”Ÿå¹´æœˆæ—¥", age:"å¹´é½¢", diagnosis:"è¨ºæ–­å", messageShort:"ä¸€è¨€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" },
    p2:{ strengths:"å¼·ã¿", interests:"èˆˆå‘³ãƒ»å¥½ããªã‚‚ã®", triggers:"è‹¦æ‰‹ï¼ˆäº‹å®Ÿï¼‰", calming:"è½ã¡ç€ãæ–¹æ³•ï¼ˆå¯¾ç­–ï¼‰" },
    p3:{ understand:"ç†è§£ã—ã‚„ã™ã„ä¼ãˆæ–¹", express:"æœ¬äººã®ä¼ãˆæ–¹", supportTips:"æ”¯æ´ã®ãƒ’ãƒ³ãƒˆ" },
    p4:{
      sensory:"æ„Ÿè¦š", life:"ç”Ÿæ´»", learning:"å­¦ç¿’",
      schoolArrival:"æœã®æº–å‚™ãƒ»ç™»æ ¡", schoolClass:"æˆæ¥­ä¸­", schoolRecess:"ä¼‘ã¿æ™‚é–“ãƒ»é›†å›£", schoolDismissal:"ä¸‹æ ¡ãƒ»åˆ‡ã‚Šæ›¿ãˆ",
      panicSigns:"äºˆå…†", panicSupport:"å¯¾å¿œ"
    },
    p5:{ teacherMessage:"å…ˆç”Ÿã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" }
  };
  return (map[pageId] && map[pageId][key]) ? map[pageId][key] : key;
}

function editBirthAge(){
  modalTitle.textContent = "ç”Ÿå¹´æœˆæ—¥ / å¹´é½¢";
  modalBody.innerHTML = "";

  const p1 = state.pages.find(p=>p.id==="p1").fields;

  const birth = document.createElement("input");
  birth.type = "text";
  birth.placeholder = "ç”Ÿå¹´æœˆæ—¥ï¼ˆä¾‹ï¼š2019/04/01ï¼‰";
  birth.value = p1.birth || "";
  const age = document.createElement("input");
  age.type = "text";
  age.placeholder = "å¹´é½¢ï¼ˆä¾‹ï¼š6æ­³3ã‹æœˆï¼‰";
  age.value = p1.age || "";

  modalBody.appendChild(birth);
  modalBody.appendChild(el("div","note",""));
  modalBody.appendChild(age);

  btnInsertExample.style.display = "none";

  btnSaveField.onclick = ()=>{
    p1.birth = birth.value;
    p1.age = age.value;
    closeModal();
    render();
  };

  modal.classList.add("show");
  setTimeout(()=>birth.focus(), 50);
}

function editTableRow(idx){
  const page = state.pages.find(p=>p.id==="p5");
  const row = page.fields.rows[idx] || {scene:"", fact:"", support:""};

  modalTitle.textContent = "å ´é¢åˆ¥ï¼ˆè¡Œ " + (idx+1) + "ï¼‰";
  modalBody.innerHTML = "";

  const scene = document.createElement("input");
  scene.type = "text";
  scene.placeholder = "å ´é¢ï¼ˆä¾‹ï¼šäºˆå®šã®å¤‰æ›´ï¼‰";
  scene.value = row.scene || "";

  const fact = document.createElement("textarea");
  fact.placeholder = "äº‹å®Ÿï¼ˆå›°ã‚Šã”ã¨ï¼‰";
  fact.value = row.fact || "";

  const sup = document.createElement("textarea");
  sup.placeholder = "å¯¾ç­–ï¼ˆå…·ä½“çš„ãŠé¡˜ã„ï¼‰";
  sup.value = row.support || "";

  modalBody.appendChild(scene);
  modalBody.appendChild(el("div","note",""));
  modalBody.appendChild(fact);
  modalBody.appendChild(el("div","note",""));
  modalBody.appendChild(sup);

  btnInsertExample.style.display = "none";

  btnSaveField.onclick = ()=>{
    row.scene = scene.value;
    row.fact = fact.value;
    row.support = sup.value;
    page.fields.rows[idx] = row;
    closeModal();
    render();
  };

  modal.classList.add("show");
  setTimeout(()=>scene.focus(), 50);
}

/* Photo editor */
let phCtx = null;
let phImgEl = null;
let phCanvas = null;
let phStart = null;

function openPhotoEditor(pageId, key){
  const ref = getPhotoRef(pageId, key);
  phCtx = { pageId, key, ref };

  modalTitle.textContent = "å†™çœŸç·¨é›†ï¼š" + (ref.caption || "å†™çœŸ");
  modalBody.innerHTML = "";

  const wrap = document.createElement("div");
  wrap.className = "photoEditor";

  const cap = document.createElement("input");
  cap.type = "text";
  cap.placeholder = "ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼šæ•™å®¤ï¼å¥½ããªã‚‚ã® ãªã©ï¼‰";
  cap.value = ref.caption || "";
  wrap.appendChild(cap);

  phCanvas = document.createElement("div");
  phCanvas.className = "phCanvas";
  wrap.appendChild(phCanvas);

  phImgEl = document.createElement("img");
  phCanvas.appendChild(phImgEl);

  const tools = document.createElement("div");
  tools.className = "phTools";

  const btnPick = document.createElement("button");
  btnPick.className = "btn";
  btnPick.textContent = "ç”»åƒã‚’é¸ã¶";
  btnPick.onclick = (e)=>{ e.stopPropagation(); pickImage(false); };

  const btnCam = document.createElement("button");
  btnCam.className = "btn";
  btnCam.textContent = "ã‚«ãƒ¡ãƒ©";
  btnCam.onclick = (e)=>{ e.stopPropagation(); pickImage(true); };

  const btnDel = document.createElement("button");
  btnDel.className = "btn";
  btnDel.textContent = "å‰Šé™¤";
  btnDel.onclick = (e)=>{
    e.stopPropagation();
    ref.dataUrl = "";
    ref.scale = 1; ref.x = 0; ref.y = 0; ref.rot = 0;
    syncPh();
  };

  tools.appendChild(btnPick);
  tools.appendChild(btnCam);
  tools.appendChild(btnDel);

  const rangeWrap = document.createElement("div");
  rangeWrap.className = "range";
  rangeWrap.appendChild(el("div","note","æ‹¡å¤§"));
  const rng = document.createElement("input");
  rng.type = "range";
  rng.min = "0.5"; rng.max = "3"; rng.step = "0.01";
  rng.value = String(ref.scale || 1);
  rng.oninput = ()=>{
    ref.scale = parseFloat(rng.value);
    syncPh();
  };
  rangeWrap.appendChild(rng);
  tools.appendChild(rangeWrap);

  const rangeWrap2 = document.createElement("div");
  rangeWrap2.className = "range";
  rangeWrap2.appendChild(el("div","note","å›è»¢"));
  const rng2 = document.createElement("input");
  rng2.type = "range";
  rng2.min = "-180"; rng2.max = "180"; rng2.step = "1";
  rng2.value = String(ref.rot || 0);
  rng2.oninput = ()=>{
    ref.rot = parseInt(rng2.value,10);
    syncPh();
  };
  rangeWrap2.appendChild(rng2);
  tools.appendChild(rangeWrap2);

  wrap.appendChild(tools);
  wrap.appendChild(el("div","note","æ“ä½œï¼šãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼ãƒ”ãƒ³ãƒã§æ‹¡å¤§ç¸®å°ï¼ˆã‚¹ãƒãƒ›ï¼‰"));

  modalBody.appendChild(wrap);

  btnInsertExample.style.display = "none";
  btnSaveField.onclick = ()=>{
    ref.caption = cap.value;
    closeModal();
    render();
  };

  modal.classList.add("show");

  enableGestures(phCanvas, rng, rng2);
  syncPh();
}

function pickImage(useCamera){
  const input = useCamera ? document.getElementById("photoCam") : document.getElementById("photoFile");
  input.onchange = async ()=>{
    const f = input.files && input.files[0];
    if(!f) return;
    const url = await fileToDataUrl(f);
    const ref = phCtx.ref;
    ref.dataUrl = url;
    ref.scale = 1;
    ref.x = 0;
    ref.y = 0;
    ref.rot = 0;
    syncPh();
    input.value = "";
  };
  input.click();
}
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
function syncPh(){
  const ref = phCtx.ref;
  if(ref.dataUrl){
    phImgEl.src = ref.dataUrl;
    phImgEl.style.display = "block";
  }else{
    phImgEl.removeAttribute("src");
    phImgEl.style.display = "none";
  }
  const rot = ref.rot || 0;
  const scale = ref.scale || 1;
  const x = ref.x || 0;
  const y = ref.y || 0;

  phImgEl.style.left = "50%";
  phImgEl.style.top = "50%";
  phImgEl.style.width = "130%";
  phImgEl.style.height = "auto";
  phImgEl.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%) rotate(${rot}deg) scale(${scale})`;
}

function enableGestures(canvas, rngScale, rngRot){
  canvas.onpointerdown = (e)=>{
    canvas.setPointerCapture(e.pointerId);
    phStart = getPointerState(e);
    phStart.ref = { x: phCtx.ref.x||0, y: phCtx.ref.y||0, scale: phCtx.ref.scale||1, rot: phCtx.ref.rot||0 };
  };
  canvas.onpointermove = (e)=>{
    if(!phStart) return;
    const cur = getPointerState(e);
    const dx = cur.x - phStart.x;
    const dy = cur.y - phStart.y;
    phCtx.ref.x = phStart.ref.x + dx;
    phCtx.ref.y = phStart.ref.y + dy;
    syncPh();
  };
  canvas.onpointerup = ()=>{ phStart = null; };
  canvas.onpointercancel = ()=>{ phStart = null; };

  let touches = new Map();
  canvas.addEventListener("touchstart", (e)=>{
    for(const t of e.changedTouches) touches.set(t.identifier, {x:t.clientX, y:t.clientY});
    if(touches.size===2){
      const pts = [...touches.values()];
      canvas._pinch = {
        d0: dist(pts[0], pts[1]),
        a0: angle(pts[0], pts[1]),
        s0: phCtx.ref.scale||1,
        r0: phCtx.ref.rot||0
      };
    }
  }, {passive:false});

  canvas.addEventListener("touchmove", (e)=>{
    if(touches.size===0) return;
    for(const t of e.changedTouches) touches.set(t.identifier, {x:t.clientX, y:t.clientY});
    if(touches.size===2 && canvas._pinch){
      e.preventDefault();
      const pts = [...touches.values()];
      const d = dist(pts[0], pts[1]);
      const a = angle(pts[0], pts[1]);
      const p = canvas._pinch;
      const ns = clamp(p.s0 * (d / Math.max(1,p.d0)), 0.5, 3);
      const nr = clamp(p.r0 + (a - p.a0), -180, 180);
      phCtx.ref.scale = ns;
      phCtx.ref.rot = nr;
      rngScale.value = String(ns);
      rngRot.value = String(Math.round(nr));
      syncPh();
    }
  }, {passive:false});

  canvas.addEventListener("touchend", (e)=>{
    for(const t of e.changedTouches) touches.delete(t.identifier);
    if(touches.size<2){
      canvas._pinch = null;
    }else if(touches.size===2){
      const pts = [...touches.values()];
      canvas._pinch = {
        d0: dist(pts[0], pts[1]),
        a0: angle(pts[0], pts[1]),
        s0: phCtx.ref.scale||1,
        r0: phCtx.ref.rot||0
      };
    }
  });
  canvas.addEventListener("touchcancel", ()=>{ touches.clear(); canvas._pinch=null; });
}

function getPointerState(e){
  const rect = phCanvas.getBoundingClientRect();
  return { x: e.clientX - rect.left - rect.width/2, y: e.clientY - rect.top - rect.height/2 };
}
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function angle(a,b){ return (Math.atan2(b.y-a.y, b.x-a.x) * 180/Math.PI); }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }

function getPhotoRef(pageId, key){
  const p = state.pages.find(x=>x.id===pageId);
  const obj = p.fields[key];
  if(!obj || typeof obj !== "object") throw new Error("Photo slot not found: " + pageId + "." + key);
  if(!("caption" in obj)) obj.caption = "å†™çœŸ";
  return obj;
}

/* helpers */
function setField(pageId, key, value){
  const p = state.pages.find(x=>x.id===pageId);
  p.fields[key] = value;
}
function valOrHint(v, hint){ return (v && String(v).trim().length) ? v : hint; }
function combineBirthAge(birth, age){ return [birth, age].filter(x=>x && String(x).trim().length).join(" / "); }

/* persistence */
function persist(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const s = JSON.parse(raw);
      return normalizeState(s);
    }
  }catch(e){}
  return deepClone(TEMPLATE);
}
function normalizeState(s){
  if(!s || !Array.isArray(s.pages)) return deepClone(TEMPLATE);
  const out = deepClone(TEMPLATE);

  out.pages.forEach(tp=>{
    const sp = s.pages.find(p=>p.id===tp.id);
    if(!sp || !sp.fields) return;

    Object.keys(tp.fields).forEach(k=>{
      const tv = tp.fields[k];
      const sv = sp.fields[k];

      if(typeof tv === "string"){
        if(typeof sv === "string") tp.fields[k] = sv;
        return;
      }
      if(Array.isArray(tv)){
        if(Array.isArray(sv) && k==="rows"){
          tp.fields.rows = sv.map(r=>({
            scene: (r?.scene ?? ""),
            fact: (r?.fact ?? ""),
            support: (r?.support ?? "")
          }));
        }
        return;
      }
      if(tv && typeof tv === "object"){
        if(sv && typeof sv === "object"){
          tp.fields[k].dataUrl = sv.dataUrl || tp.fields[k].dataUrl || "";
          tp.fields[k].scale = (sv.scale ?? tp.fields[k].scale ?? 1);
          tp.fields[k].x = (sv.x ?? tp.fields[k].x ?? 0);
          tp.fields[k].y = (sv.y ?? tp.fields[k].y ?? 0);
          tp.fields[k].rot = (sv.rot ?? tp.fields[k].rot ?? 0);
          tp.fields[k].caption = (sv.caption ?? tp.fields[k].caption ?? "å†™çœŸ");
        }
      }
    });
  });

  return out;
}

/* header actions */
document.getElementById("btnPrint").onclick = startPrintAllPagesSync;

document.getElementById("btnExport").onclick = ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "support_book_data.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
};

document.getElementById("btnImport").onclick = ()=>{
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async ()=>{
    const f = inp.files && inp.files[0];
    if(!f) return;
    const text = await f.text();
    try{
      const obj = JSON.parse(text);
      state = normalizeState(obj);
      currentPage = 0;
      render();
      alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    }catch(e){
      alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚");
    }
  };
  inp.click();
};

document.getElementById("btnReset").onclick = ()=>{
  if(confirm("å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
    state = deepClone(TEMPLATE);
    currentPage = 0;
    render();
  }
};

/* init */
render();
</script>

</body>
</html>
